<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Output\OutputInterface; use Symfony\Component\Filesystem\Filesystem; use Symfony\Component\Process\Process; class CacheWarmerCommand extends Command { const USER_AGENT = "\x4d\x67\164\x56\141\x72\x6e\151\x73\x68\x43\162\141\x77\154\145\162"; const CACHE_WARMER_CACHE_KEY = "\115\147\164\103\x61\143\x68\145\x57\141\162\155\145\x72"; const CACHE_WARMER_CRAWLED_URLS = "\115\147\164\103\x61\x63\150\145\127\141\162\155\145\x72\103\162\141\167\154\145\x64\x55\162\x6c\x73"; protected $curlAdapter; protected $logger; protected $directoryList; protected $storeManager; protected $cache; protected $cachePurger; protected $lockFile; protected $isLocked; protected $varnishConfig; protected $urlResource; protected $urlQueueResource; protected $urlQueueCollection; public function __construct(\Magento\Framework\HTTP\Adapter\Curl $curlAdapter, \Psr\Log\LoggerInterface $logger, \Magento\Framework\App\Filesystem\DirectoryList $directoryList, \Magento\Store\Model\StoreManagerInterface $storeManager, \Mgt\Varnish\Model\Cache\Backend\File $cache, \Magento\CacheInvalidate\Model\PurgeCache $cachePurger, \Mgt\Varnish\Model\Cache\Config $varnishConfig, \Mgt\Varnish\Model\ResourceModel\Url $urlResource, \Mgt\Varnish\Model\ResourceModel\UrlQueue $urlQueueResource, \Mgt\Varnish\Model\ResourceModel\UrlQueue\Collection $urlQueueCollection) { goto E9820; E1a54: $this->urlQueueCollection = $urlQueueCollection; goto C6c9f; b0c1e: $this->varnishConfig = $varnishConfig; goto Df3bc; ffd6c: $this->urlQueueResource = $urlQueueResource; goto E1a54; E9820: $this->curlAdapter = $curlAdapter; goto Cdc9b; E8988: $this->cachePurger = $cachePurger; goto b0c1e; C6c9f: parent::__construct(); goto De768; cdd93: $this->storeManager = $storeManager; goto Afccb; Df3bc: $this->urlResource = $urlResource; goto ffd6c; Ef780: $this->directoryList = $directoryList; goto cdd93; Afccb: $this->cache = $cache; goto E8988; Cdc9b: $this->logger = $logger; goto Ef780; De768: } protected function configure() { goto Be425; edde2: $this->setDescription("\x4d\x47\124\40\126\x61\x72\156\151\x73\x68\40\103\x61\x63\150\145\x20\x57\141\x72\155\145\x72"); goto e53ce; e53ce: parent::configure(); goto E6f44; Be425: $this->setName("\155\x67\x74\x2d\x76\141\162\156\151\163\150\x3a\143\x61\x63\x68\x65\55\x77\x61\162\x6d\145\162"); goto edde2; E6f44: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto A532d; e57e7: $this->updateTimestamp(); goto Cabd1; Fc4de: if (!($i == 1000)) { goto ff95b; } goto eead0; E6774: return \Magento\Framework\Console\Cli::RETURN_SUCCESS; goto Bbaf6; B67c3: $this->lock(); goto b1d19; F7597: if (false === $this->isLocked()) { goto A26a1; } goto B8936; F55d3: A26a1: goto B67c3; A29d0: $numberOfThreads = $this->varnishConfig->getNumberOfCacheWarmerThreads(); goto c44d0; d3a36: $output->writeln(sprintf("\x43\165\x72\x72\145\x6e\164\154\171\x20\x74\150\145\40\103\x50\x55\x20\x6c\x69\x6d\151\164\40\150\x61\163\x20\x62\145\x65\156\x20\x72\x65\141\x63\150\x65\144\54\x20\x43\120\125\x3a\40\42\45\x73\x20\x70\x65\162\x63\145\x6e\164\42\54\x20\x4c\151\x6d\x69\164\x3a\x20\x22\45\163\x20\x70\145\x72\x63\x65\x6e\x74\x22", round($totalCpuUtilization), round($cacheWarmerCpuLimit))); goto c736b; E7a59: $break = true; goto d3a36; B75bc: ccabc: goto e57e7; B97b3: goto Ff0fe; goto d0b55; C200f: $totalCpuUtilization = $loadAverage[0] * 100 / $numberOfProcessingUnits; goto Cfa66; Cfa66: $totalCpuUtilization = min($totalCpuUtilization, 100); goto D5872; d3951: $numberOfProcessingUnits = $this->runCommand("\156\160\x72\157\x63"); goto A8797; b1f4e: $i = 0; goto B75bc; E57be: if (count($this->urlQueueCollection)) { goto F13d8; } goto bf382; D5b6c: $this->urlQueueCollection->addOrder("\160\x72\x69\157\x72\x69\164\x79"); goto f6587; E3c77: ff95b: goto E4540; B0842: F1faa: goto E6774; ca3c8: Ff0fe: goto e49da; d0b55: F13d8: goto bcd59; bf382: $break = true; goto B97b3; Ec0c2: $this->deleteFromQueue($urls); goto ca3c8; E4540: if ($break == false) { goto ccabc; } goto e065e; f1a71: $break = false; goto b1f4e; c44d0: $i = $i + $numberOfThreads; goto b735d; F4272: if (!(true === $isCacheWarmerCpuLimitEnabled)) { goto c1f6e; } goto d3951; bcd59: $urls = []; goto b7a98; b1d19: $this->deleteExpiredUrls(); goto f1a71; D5872: $cacheWarmerCpuLimit = $this->varnishConfig->getCacheWarmerCpuLimit(); goto b3b6e; b3b6e: if (!($totalCpuUtilization > $cacheWarmerCpuLimit)) { goto C75ad; } goto E7a59; e87b3: goto F1faa; goto F55d3; B8936: $output->writeln("\x43\141\143\x68\145\x20\127\x61\x72\x6d\145\162\40\x69\x73\40\x61\x6c\162\x65\x61\x64\171\40\x72\x75\156\x6e\x69\x6e\x67"); goto e87b3; e49da: cfb30: goto Fc4de; Cabd1: $isCacheWarmerCpuLimitEnabled = $this->varnishConfig->isCacheWarmerCpuLimitEnabled(); goto F4272; b441e: D3822: goto Ee8d4; A8797: $loadAverage = sys_getloadavg(); goto C200f; A532d: ini_set("\155\145\x6d\x6f\x72\x79\x5f\154\x69\x6d\x69\164", "\x32\60\64\70\115"); goto F7597; fb30b: if (!(false === $break)) { goto cfb30; } goto A29d0; b7a98: foreach ($this->urlQueueCollection as $urlQueue) { try { goto c9379; c9379: $storeId = $urlQueue->getStoreId(); goto E29d3; b5d90: $urls[$urlQueue->getId()] = $url; goto e1608; Fd36a: $url = sprintf("\45\x73\x2f\45\x73", rtrim($store->getBaseUrl(), "\57"), ltrim($urlQueue->getPath(), "\57")); goto b5d90; E29d3: $store = $this->storeManager->getStore($storeId); goto Fd36a; e1608: } catch (\Exception $e) { } Af2e1: } goto b441e; Ee8d4: $this->crawlUrls($urls, $output); goto Ec0c2; f6587: $this->urlQueueCollection->load(); goto E57be; Ebcee: $this->urlQueueCollection->setPageSize($numberOfThreads); goto D5b6c; eead0: $break = true; goto E3c77; e065e: Da637: goto B0842; b735d: $this->urlQueueCollection->clear(); goto Ebcee; c736b: C75ad: goto cefbc; cefbc: c1f6e: goto fb30b; Bbaf6: } catch (\Exception $e) { goto Ccd38; c5a13: $output->writeln(sprintf("\74\x65\x72\162\157\x72\76\x25\x73\x3c\x2f\145\x72\x72\x6f\x72\x3e", $errorMessage)); goto B6ce7; Ccd38: $errorMessage = $e->getMessage(); goto c5a13; B6ce7: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto e781b; e781b: } } protected function updateTimestamp() { goto f88e4; f88e4: $now = new \DateTime("\x6e\157\x77", new \DateTimeZone("\x55\x54\x43")); goto a20cd; a20cd: $now = $now->getTimestamp(); goto e546e; e546e: $this->cache->save($now, self::CACHE_WARMER_CACHE_KEY); goto fcc61; fcc61: } public function crawlUrls(array $urls, OutputInterface $output) { try { goto d16d6; D31a5: foreach ($urls as $url) { $output->writeln(sprintf("\74\x69\156\146\157\x3e\42\45\163\x22\40\x63\162\141\167\154\145\x64\74\57\x69\x6e\x66\157\76", $url)); C2b3b: } goto d8083; d8083: a652b: goto dc1e5; d16d6: $options = array(CURLOPT_USERAGENT => self::USER_AGENT, CURLOPT_SSL_VERIFYPEER => 0); goto bad1a; bad1a: $this->curlAdapter->multiRequest($urls, $options); goto D31a5; dc1e5: } catch (\Exception $e) { $errorMessage = sprintf("\101\x6e\40\145\162\162\x6f\x72\x20\x6f\143\x63\x75\x72\162\x65\144\x20\x64\x75\x72\x69\156\x67\40\x63\162\141\167\x6c\x69\156\x67\x20\165\162\x6c\163\54\40\x65\x72\162\x6f\x72\40\155\x65\163\163\141\x67\x65\x3a\40\45\x73", $e->getMessage()); $this->logger->error($errorMessage); } } protected function deleteExpiredUrls() { try { $this->urlResource->deleteExpiredUrls(); } catch (\Exception $e) { $errorMessage = sprintf("\x41\156\40\x65\x72\x72\157\x72\40\157\143\x63\165\162\x72\145\144\40\144\x75\162\x69\156\x67\40\x64\145\x6c\x65\x74\151\x6e\147\40\x65\170\x70\151\162\x65\144\40\165\x72\154\163\x2c\x20\x65\162\x72\x6f\x72\x20\x6d\x65\x73\163\x61\x67\145\72\x20\x25\163", $e->getMessage()); $this->logger->error($errorMessage); } } public function deleteFromQueue(array $urls) { try { $urlIds = array_keys($urls); $this->urlQueueResource->deleteFromQueue($urlIds); } catch (\Exception $e) { $errorMessage = sprintf("\x41\x6e\x20\145\x72\x72\157\x72\40\x6f\143\143\165\162\162\145\144\40\x64\x75\x72\x69\156\147\x20\x64\x65\x6c\145\164\151\156\x67\40\x75\x72\154\163\x2c\x20\145\x72\x72\x6f\x72\x20\155\x65\163\163\x61\x67\x65\72\40\45\163", $e->getMessage()); $this->logger->error($errorMessage); } } protected function getLockFile() { goto Cd26d; a1330: F5d7e: goto B4c7a; e8192: fwrite($this->lockFile, date("\x72")); goto a1330; a28e4: $filesystem->mkdir(dirname($lockFile)); goto Bb8e3; d9914: $lockFileDirectory = $this->directoryList->getPath("\x74\x6d\x70"); goto cf121; cf121: $lockFile = sprintf("\x25\x73\57\155\x67\x74\137\166\141\x72\x6e\x69\x73\150\x5f\x63\141\x63\150\x65\x5f\x63\162\x61\167\x6c\x65\162\56\154\x6f\143\x6b", $lockFileDirectory); goto c1279; bd815: $this->lockFile = fopen($lockFile, "\170"); goto e0bd3; Cd26d: if (!(null === $this->lockFile)) { goto F5d7e; } goto d9914; e0bd3: goto b3cea; goto Da0b2; Bb8e3: if (is_file($lockFile)) { goto Ae5d5; } goto bd815; Da0b2: Ae5d5: goto eebdd; c1279: $filesystem = new Filesystem(); goto a28e4; A8970: b3cea: goto e8192; B4c7a: return $this->lockFile; goto d4582; eebdd: $this->lockFile = fopen($lockFile, "\167"); goto A8970; d4582: } protected function lock() { goto f0fe0; B2aa5: flock($lockFile, LOCK_EX | LOCK_NB); goto F6df7; F6df7: return $this; goto D8182; ab63d: $lockFile = $this->getLockFile(); goto B2aa5; f0fe0: $this->isLocked = true; goto ab63d; D8182: } protected function unlock() { goto e546b; ea48c: $lockFile = $this->getLockFile(); goto ac795; Eb850: return $this; goto F902a; ac795: flock($lockFile, LOCK_UN); goto Eb850; e546b: $this->isLocked = false; goto ea48c; F902a: } protected function isLocked() { goto Af52f; Af52f: if ($this->isLocked !== null) { goto a5578; } goto D202a; d4118: goto F55f4; goto B1cd1; c3c9e: flock($fp, LOCK_UN); goto b7bd1; D202a: $fp = $this->getLockFile(); goto A5360; Acc10: F55f4: goto F2361; da17d: return $this->isLocked; goto Acc10; B5124: Ae341: goto e2965; B1cd1: a5578: goto da17d; b7bd1: return false; goto B5124; A5360: if (!flock($fp, LOCK_EX | LOCK_NB)) { goto Ae341; } goto c3c9e; e2965: return true; goto d4118; F2361: } protected function runCommand($command, $timeout = 30) { goto E8325; Acd30: e3822: goto fe28c; e08b1: $process->run(); goto A9077; F8dc9: $process->setTimeout($timeout); goto e08b1; A9077: if (!(false === $process->isSuccessful())) { goto e3822; } goto E97b2; E97b2: throw new \RuntimeException($process->getErrorOutput()); goto Acd30; fe28c: $output = trim($process->getOutput()); goto A6cdb; A6cdb: return $output; goto dc497; E8325: $process = Process::fromShellCommandline($command, "\x2f\x74\155\160\57"); goto F8dc9; dc497: } public function __destruct() { $this->unlock(); } }
