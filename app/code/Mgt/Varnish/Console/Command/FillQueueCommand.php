<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputArgument; use Symfony\Component\Console\Input\InputOption; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Input\InputDefinition; use Symfony\Component\Console\Output\OutputInterface; class FillQueueCommand extends Command { const INPUT_STORE_ID = "\x73\x74\x6f\x72\x65\x2d\x69\x64"; const ENTITY_TYPE_CATEGORY = "\x63\141\164\x65\x67\157\x72\171"; const ENTITY_TYPE_PRODUCT = "\160\x72\x6f\144\165\143\x74"; const URL_QUEUE_BATCH_SIZE = 2500; protected $logger; protected $storeManager; protected $categoryCollection; protected $urlQueueResource; protected $urlQueue; protected $numberOfUrls = 0; protected $categories = []; protected $state; public function __construct() { goto A96ff; c6f02: $this->logger = $objectManager->get("\134\x50\163\162\x5c\114\157\x67\134\x4c\157\147\147\145\162\111\156\x74\145\162\x66\141\x63\145"); goto fdd8b; Dcd98: $this->categoryCollection = $objectManager->get("\134\115\x61\x67\x65\156\x74\x6f\134\x43\141\x74\141\x6c\157\x67\134\115\x6f\144\x65\154\x5c\122\145\163\157\165\x72\x63\x65\115\x6f\x64\x65\154\134\103\x61\x74\145\147\157\x72\171\x5c\x43\x6f\x6c\x6c\145\x63\x74\151\x6f\156"); goto C9475; C9475: $this->urlQueueResource = $objectManager->get("\x5c\x4d\x67\x74\134\x56\141\x72\x6e\151\163\150\134\115\x6f\x64\x65\154\134\x52\145\x73\157\x75\162\x63\145\115\x6f\144\145\x6c\134\125\162\x6c\121\x75\x65\165\145"); goto E46c9; fdd8b: $this->storeManager = $objectManager->get("\134\x4d\141\x67\x65\x6e\164\x6f\134\x53\x74\x6f\162\x65\x5c\x4d\x6f\144\145\x6c\134\x53\164\x6f\x72\x65\115\141\x6e\141\x67\145\162\x49\x6e\x74\145\162\x66\141\143\x65"); goto Dcd98; Cde69: parent::__construct(); goto De92d; E46c9: $this->urlQueue = $objectManager->get("\134\115\147\x74\134\126\141\x72\156\151\x73\150\134\115\x6f\144\x65\x6c\x5c\125\x72\154\x51\165\145\165\145"); goto Cde69; A96ff: $objectManager = $this->getObjectManager(); goto c6f02; De92d: } protected function configure() { goto d4832; d4832: $this->setName("\155\147\164\55\x76\141\x72\156\151\x73\x68\72\x66\151\x6c\x6c\x2d\x71\165\x65\165\x65"); goto A97e7; dac4f: parent::configure(); goto bc15b; ab665: $this->setDefinition(new InputDefinition(array(new InputOption(self::INPUT_STORE_ID, null, InputOption::VALUE_OPTIONAL, '')))); goto dac4f; A97e7: $this->setDescription("\x4d\x47\x54\x20\126\141\162\156\151\x73\150\x20\x43\x61\143\150\145\40\x51\165\145\165\145\40\106\151\x6c\x6c\145\162"); goto ab665; bc15b: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto F540c; F9a7d: b790c: goto b11f1; e3190: $output->writeln(sprintf("\x3c\151\x6e\146\157\x3e\45\x73\x20\x55\x52\x4c\163\x20\141\x64\x64\x65\x64\x20\164\157\40\x56\141\x72\156\x69\163\x68\40\121\x75\x65\165\145\x3c\x2f\x69\156\146\x6f\76", $this->numberOfUrls)); goto Cd984; Ea70d: if (!($this->numberOfUrls > 0)) { goto a0af7; } goto e3190; f9bdf: $storeId = (int) $input->getOption(self::INPUT_STORE_ID); goto c2188; f0972: $store = null; goto f9bdf; b11f1: $this->addCategoryUrls($store); goto D7758; c2188: if (!$storeId) { goto b790c; } goto c92ca; D7758: $this->addProductUrls($store); goto Ea70d; Cd984: a0af7: goto d226a; d226a: return \Magento\Framework\Console\Cli::RETURN_SUCCESS; goto b3a70; F540c: ini_set("\x6d\x65\155\157\x72\x79\x5f\x6c\151\x6d\151\164", "\62\x30\64\x38\x4d"); goto f0972; c92ca: try { $store = $this->storeManager->getStore($storeId); $this->storeManager->setCurrentStore($store); } catch (\Exception $e) { goto E6ab3; b0fd5: $output->writeln(sprintf("\x3c\143\157\x6d\x6d\x65\156\164\76\x41\x76\x61\151\154\x61\142\154\145\40\x53\x74\x6f\162\145\x73\x3c\x2f\143\157\x6d\155\145\x6e\164\76")); goto E24a6; E24a6: return $this->showStores($output); goto b3d62; D421d: $output->writeln(''); goto b0fd5; E6ab3: $output->writeln(sprintf("\x3c\145\x72\x72\157\162\76\x53\x74\157\162\x65\x20\167\151\x74\150\x20\x49\x44\x20\x22\x25\x73\x22\x20\144\157\x65\163\40\x6e\157\164\x20\x65\170\151\x73\164\x73\x3c\57\x65\x72\162\x6f\162\76", $storeId)); goto D421d; b3d62: } goto F9a7d; b3a70: } catch (\Exception $e) { goto F5b05; A8790: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto b4c8e; F5b05: $errorMessage = $e->getMessage(); goto b2e57; b2e57: $output->writeln(sprintf("\74\145\162\x72\x6f\x72\76\45\x73\x3c\57\x65\x72\162\x6f\162\x3e", $errorMessage)); goto A8790; b4c8e: } } protected function addCategoryUrls(?\Magento\Store\Model\Store $store = null) { goto d8007; E3a5d: $urlRewriteCollection = $objectManager->create("\134\115\147\x74\x5c\126\x61\x72\x6e\x69\x73\150\x5c\x4d\157\144\145\x6c\x5c\x52\x65\163\157\165\x72\143\145\115\x6f\144\x65\x6c\x5c\125\162\x6c\x52\145\x77\162\x69\164\x65\134\125\x72\x6c\x52\x65\167\x72\x69\x74\145\103\157\154\154\x65\x63\x74\151\x6f\x6e"); goto C3747; af938: $this->categoryCollection->addAttributeToSelect("\145\156\x74\x69\x74\171\137\x69\x64"); goto Cdb06; Ec4db: if (!count($this->categories)) { goto Ae05b; } goto b7892; E10c4: foreach ($urlRewriteCollection as $urlRewrite) { goto A2a20; E1dd6: E51f1: goto Be7e9; D6cc6: if (isset($urlRewrites[$urlRewriteId])) { goto ef83c; } goto d19be; F0292: ef83c: goto E1dd6; C78ee: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto F0292; d19be: $urls[] = ["\163\164\x6f\x72\x65\137\151\144" => $urlRewrite->getStoreId(), "\160\x61\164\150" => $urlRewrite->getRequestPath(), "\x70\162\x69\x6f\162\x69\x74\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_MEDIUM]; goto C78ee; A2a20: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto D6cc6; Be7e9: } goto B6b14; B6b14: Dbc0e: goto ccc4a; ccbaf: $this->urlQueue->addToQueue($urls); goto ead83; Cdb06: foreach ($this->categoryCollection as $category) { $this->categories[$category->getId()] = $category; d6dc2: } goto D8ab8; Aa39d: Ae05b: goto Fd9db; C98ae: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_CATEGORY); goto f3549; b7892: $categoryIds = array_keys($this->categories); goto C98ae; D8ab8: Ce2a0: goto Ec4db; f3549: $urlRewriteCollection->addEntityIdFilter($categoryIds); goto a924c; ccc4a: if (!count($urls)) { goto df921; } goto dc8ac; a924c: $urlRewrites = []; goto Bcdc2; d8007: $objectManager = $this->getObjectManager(); goto E3a5d; C3747: if (!(null !== $store)) { goto c42f3; } goto ec989; A6423: $urlRewriteCollection->addStoreFilter($storeId, false); goto e95fc; ec989: $storeId = $store->getStoreId(); goto C46e7; dc8ac: $this->numberOfUrls += count($urls); goto ccbaf; Bcdc2: $urls = []; goto E10c4; e95fc: c42f3: goto af938; C46e7: $this->categoryCollection->setStore($store); goto A6423; ead83: df921: goto Aa39d; Fd9db: } protected function addProductUrls(?\Magento\Store\Model\Store $store = null) { goto e883b; Bd64e: $productStatus = $objectManager->get("\134\x4d\x61\x67\x65\x6e\164\x6f\134\x43\141\164\x61\154\157\147\x5c\x4d\x6f\144\145\154\x5c\x50\x72\x6f\x64\x75\143\x74\x5c\101\x74\x74\x72\151\142\165\x74\x65\x5c\x53\x6f\x75\162\x63\145\134\123\x74\x61\164\165\163"); goto d5fa2; d5fa2: $productVisibility = $objectManager->get("\x5c\x4d\x61\147\145\156\164\x6f\134\x43\x61\164\x61\154\157\147\x5c\115\157\144\145\154\134\120\x72\x6f\144\165\143\x74\134\x56\151\163\151\142\x69\x6c\x69\164\x79"); goto bae11; e883b: if (!count($this->categories)) { goto dbb8c; } goto a1c09; a1c09: $objectManager = $this->getObjectManager(); goto b7a7b; Ecef5: foreach ($this->categories as $category) { goto ff5ea; B7555: $productCollection->addStoreFilter($store); goto A024d; Bd519: $urlRewriteCollection = $objectManager->create("\x5c\x4d\x67\x74\x5c\x56\x61\162\156\151\163\x68\x5c\x4d\x6f\x64\145\154\x5c\122\145\163\157\165\162\143\x65\x4d\x6f\x64\x65\x6c\x5c\125\x72\154\x52\145\x77\x72\151\x74\x65\x5c\125\x72\x6c\122\x65\167\162\151\164\x65\103\x6f\154\154\x65\x63\164\151\157\156"); goto Cc1f3; a1c86: Ec0d2: goto f827c; d7398: $productCollection->clear(); goto E3517; fc616: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_PRODUCT); goto F08f8; D6aed: $storeId = $store->getStoreId(); goto Fab53; a95ec: $entityIds = []; goto E4ad8; f827c: A0f52: goto a3719; Cc1f3: if (!(null !== $store)) { goto F2934; } goto D6aed; E42ef: $productCollection->setPageSize(self::URL_QUEUE_BATCH_SIZE); goto a95ec; C495a: $productCollection->setVisibility($productVisibility->getVisibleInSiteIds()); goto c1440; c1440: $productCollection->addCategoryFilter($category); goto abedf; B7c7a: if (!count($urls)) { goto F63a8; } goto c916c; ff5ea: $productCollection = $objectManager->create("\134\115\x61\x67\x65\x6e\164\x6f\134\103\141\164\x61\154\157\147\134\115\x6f\144\145\x6c\x5c\122\x65\x73\x6f\165\162\x63\x65\x4d\x6f\144\145\154\x5c\x50\x72\x6f\144\x75\x63\x74\134\103\x6f\x6c\x6c\x65\x63\164\151\x6f\156"); goto C52b9; Eec3c: f0a31: goto edd55; C619b: $productCollection->setCurPage(++$i); goto E42ef; Ea19d: $i = 0; goto D7be3; A024d: C6512: goto C619b; b9794: F2934: goto fc616; B7f22: F63a8: goto Eec3c; E4ad8: foreach ($productCollection as $product) { goto d6104; C2dc1: if ("\143\x6f\x6e\x66\151\147\x75\162\141\142\x6c\x65" == $product->getTypeId()) { goto Ebc5d; } goto a3a3c; c2058: fdf8c: goto ab48f; a3a3c: $parentIds = $configurableProduct->getParentIdsByChild($productId); goto C9e72; Bfb5e: b07b1: goto f6b92; d6104: $productId = $product->getId(); goto a4386; D4d0b: $productIds[$productId] = $productId; goto bd880; C9e72: if (!(true === empty($parentIds))) { goto E04f9; } goto cce76; ab48f: F4020: goto Bfb5e; c9fd6: $entityIds[$productId] = $productId; goto Ef063; cce76: $productIds[$productId] = $productId; goto c9fd6; Ef063: E04f9: goto Cb180; c1475: Ebc5d: goto D4d0b; a4386: if (isset($productIds[$productId])) { goto F4020; } goto C2dc1; Cb180: goto fdf8c; goto c1475; bd880: $entityIds[$productId] = $productId; goto c2058; f6b92: } goto Bbd88; E3517: if (!(null !== $store)) { goto C6512; } goto B7555; C20b8: $productCollection->addAttributeToFilter("\163\164\x61\164\165\163", ["\151\156" => $productStatus->getVisibleStatusIds()]); goto C495a; B750e: $urlRewrites = []; goto e86cb; Bbd88: C126c: goto bd126; f8b9a: foreach ($urlRewriteCollection as $urlRewrite) { goto c8fcc; A2db0: $urls[] = ["\163\164\x6f\162\x65\x5f\x69\144" => $urlRewrite->getStoreId(), "\x70\141\x74\x68" => $urlRewrite->getRequestPath(), "\x70\x72\151\157\x72\x69\164\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_LOW]; goto Ec4dd; Ec4dd: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto e3c71; C1f9e: if (isset($urlRewrites[$urlRewriteId])) { goto c1471; } goto A2db0; Ed609: E2fa4: goto C69e3; c8fcc: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto C1f9e; e3c71: c1471: goto Ed609; C69e3: } goto Fdb2c; F08f8: $urlRewriteCollection->addEntityIdFilter($entityIds); goto B750e; e86cb: $urls = []; goto f8b9a; Fab53: $urlRewriteCollection->addStoreFilter($storeId, false); goto b9794; D7be3: Dec7f: goto d7398; Dc3ba: $break = true; goto C539c; C52b9: $productCollection->addAttributeToSelect(["\145\156\164\x69\x74\171\137\151\144", "\x73\164\141\164\x75\x73"]); goto C20b8; f227d: $this->urlQueue->addToQueue($urls); goto B7f22; abedf: $break = false; goto Ea19d; Cf6e0: E92d1: goto Bd519; bd126: if (false === empty($entityIds)) { goto E92d1; } goto Dc3ba; c916c: $this->numberOfUrls += count($urls); goto f227d; Fdb2c: b1e96: goto B7c7a; edd55: if ($break == false) { goto Dec7f; } goto a1c86; C539c: goto f0a31; goto Cf6e0; a3719: } goto b7a4f; fa5ef: dbb8c: goto ddacb; b7a4f: Eb1de: goto fa5ef; b7a7b: $configurableProduct = $objectManager->get("\x5c\x4d\141\x67\145\156\164\x6f\x5c\103\x6f\x6e\146\x69\147\x75\162\x61\x62\154\x65\x50\x72\157\x64\x75\x63\164\134\x4d\157\x64\x65\154\x5c\x52\145\x73\157\x75\x72\143\145\x4d\x6f\x64\145\154\134\120\162\x6f\144\x75\x63\164\134\x54\171\160\x65\x5c\103\157\x6e\146\x69\147\x75\x72\141\142\154\x65"); goto Bd64e; bae11: $productIds = []; goto Ecef5; ddacb: } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } protected function showStores(OutputInterface $output) { goto E8d28; C063c: Ad45d: goto A101c; E8d28: $table = $this->getHelperSet()->get("\164\x61\x62\154\145"); goto D8f51; B8aaa: $stores = $this->storeManager->getStores(); goto A0ead; A0ead: foreach ($stores as $store) { goto A2feb; A2feb: $row = [$store->getStoreId(), $store->getBaseUrl()]; goto bcd24; F4728: afeaf: goto b46b6; bcd24: $table->addRow($row); goto F4728; b46b6: } goto C063c; A101c: $table->render($output); goto Ffa4b; D8f51: $table->setHeaders(["\x53\x74\157\x72\x65\x20\x49\x44", "\x42\141\x73\x65\40\125\122\x4c"]); goto B8aaa; Ffa4b: } }
