<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputArgument; use Symfony\Component\Console\Input\InputOption; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Input\InputDefinition; use Symfony\Component\Console\Output\OutputInterface; class FillQueueCommand extends Command { const INPUT_STORE_ID = "\163\164\157\x72\145\x2d\x69\144"; const ENTITY_TYPE_CATEGORY = "\143\141\x74\x65\147\157\162\171"; const ENTITY_TYPE_PRODUCT = "\160\162\x6f\144\x75\143\164"; const URL_QUEUE_BATCH_SIZE = 2500; protected $logger; protected $storeManager; protected $categoryCollection; protected $urlQueueResource; protected $urlQueue; protected $numberOfUrls = 0; protected $categories = []; protected $state; public function __construct() { goto dd6f5; be066: $this->urlQueueResource = $objectManager->get("\x5c\115\x67\x74\134\126\141\162\156\x69\x73\150\134\x4d\157\x64\145\x6c\134\122\145\x73\x6f\x75\x72\x63\145\x4d\157\x64\x65\154\134\125\x72\x6c\x51\165\145\165\x65"); goto aa4c0; aa4c0: $this->urlQueue = $objectManager->get("\x5c\115\147\164\134\x56\x61\162\156\151\x73\x68\x5c\x4d\157\x64\145\x6c\x5c\x55\162\154\x51\165\x65\165\x65"); goto B0ead; B0ead: parent::__construct(); goto ad8a7; A36aa: $this->logger = $objectManager->get("\134\x50\x73\x72\134\x4c\157\x67\x5c\x4c\157\147\147\x65\x72\x49\x6e\x74\x65\162\x66\x61\143\x65"); goto c0920; dd6f5: $objectManager = $this->getObjectManager(); goto A36aa; c0920: $this->storeManager = $objectManager->get("\x5c\115\x61\x67\x65\156\x74\157\134\x53\x74\157\x72\145\x5c\115\x6f\x64\145\154\x5c\x53\164\157\162\145\x4d\x61\156\x61\147\x65\x72\x49\156\164\x65\162\146\141\143\145"); goto A2349; A2349: $this->categoryCollection = $objectManager->get("\x5c\115\x61\147\145\x6e\x74\x6f\134\103\x61\x74\x61\x6c\157\147\134\x4d\157\144\145\x6c\134\122\145\163\x6f\165\x72\143\x65\115\157\144\x65\154\x5c\103\x61\x74\145\147\x6f\x72\x79\x5c\x43\157\x6c\x6c\145\x63\x74\x69\157\x6e"); goto be066; ad8a7: } protected function configure() { goto Bc99d; A880e: parent::configure(); goto fa2e7; Bc99d: $this->setName("\155\147\164\55\166\x61\x72\x6e\151\x73\150\x3a\146\x69\x6c\x6c\55\161\165\x65\165\145"); goto f3825; Bde0c: $this->setDefinition(new InputDefinition(array(new InputOption(self::INPUT_STORE_ID, null, InputOption::VALUE_OPTIONAL, '')))); goto A880e; f3825: $this->setDescription("\x4d\x47\x54\x20\x56\x61\x72\156\151\163\150\x20\x43\x61\x63\150\145\40\121\165\x65\165\x65\x20\106\151\154\x6c\145\162"); goto Bde0c; fa2e7: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto Fdec7; E4c38: if (!$storeId) { goto E7a8f; } goto b2c76; Fdec7: ini_set("\x6d\145\x6d\157\162\171\x5f\x6c\x69\155\151\164", "\62\x30\x34\70\x4d"); goto F7184; f205f: $this->addCategoryUrls($store); goto c54b4; c032f: if (!($this->numberOfUrls > 0)) { goto a7446; } goto ae6f2; ae6f2: $output->writeln(sprintf("\x3c\151\x6e\x66\157\x3e\45\x73\40\125\x52\114\x73\40\141\144\x64\145\144\x20\164\157\40\126\141\162\x6e\x69\x73\150\40\121\165\x65\165\145\x3c\x2f\151\x6e\146\x6f\x3e", $this->numberOfUrls)); goto bbacc; F7184: $store = null; goto Daf2d; f48b3: E7a8f: goto f205f; c54b4: $this->addProductUrls($store); goto c032f; Daf2d: $storeId = (int) $input->getOption(self::INPUT_STORE_ID); goto E4c38; b2c76: try { $store = $this->storeManager->getStore($storeId); $this->storeManager->setCurrentStore($store); } catch (\Exception $e) { goto b13d8; a1c36: return $this->showStores($output); goto fa495; f5a31: $output->writeln(sprintf("\x3c\143\x6f\x6d\x6d\x65\156\x74\x3e\101\x76\x61\151\154\141\x62\154\145\x20\123\164\157\162\x65\163\74\x2f\143\x6f\x6d\x6d\x65\x6e\164\x3e")); goto a1c36; C4a59: $output->writeln(''); goto f5a31; b13d8: $output->writeln(sprintf("\x3c\145\x72\162\x6f\162\x3e\x53\x74\x6f\162\x65\40\x77\151\164\150\40\x49\x44\x20\x22\45\x73\42\x20\144\x6f\145\x73\x20\156\157\x74\x20\145\170\x69\x73\x74\x73\x3c\x2f\x65\x72\162\x6f\x72\x3e", $storeId)); goto C4a59; fa495: } goto f48b3; bbacc: a7446: goto De4d3; De4d3: } catch (\Exception $e) { goto c931e; d8964: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto c8dc3; F2089: $output->writeln(sprintf("\74\145\x72\162\x6f\x72\76\x25\x73\74\x2f\x65\162\x72\x6f\162\x3e", $errorMessage)); goto d8964; c931e: $errorMessage = $e->getMessage(); goto F2089; c8dc3: } } protected function addCategoryUrls(\Magento\Store\Model\Store $store = null) { goto Eccde; F483b: $urlRewriteCollection->addStoreFilter($storeId, false); goto a50e4; Ff118: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_CATEGORY); goto e32b8; e32b8: $urlRewriteCollection->addEntityIdFilter($categoryIds); goto F0700; b9201: $this->numberOfUrls += count($urls); goto F8e69; D8df5: $this->categoryCollection->addAttributeToSelect("\x65\x6e\x74\151\164\x79\137\x69\x64"); goto Faea9; F9f83: B26d2: goto Ae026; de733: d3182: goto fd214; ed6fe: e231d: goto e5e08; ba063: $urlRewriteCollection = $objectManager->create("\134\115\147\x74\x5c\126\x61\x72\x6e\x69\163\x68\x5c\x4d\157\x64\x65\154\x5c\122\x65\163\x6f\x75\162\x63\x65\x4d\x6f\x64\x65\154\134\125\162\154\x52\x65\167\x72\151\164\145\x5c\125\x72\x6c\x52\x65\x77\x72\x69\x74\x65\103\x6f\154\x6c\x65\143\164\x69\157\156"); goto B125a; F8e69: $this->urlQueue->addToQueue($urls); goto de733; dd43d: foreach ($urlRewriteCollection as $urlRewrite) { goto E458d; b88e7: if (isset($urlRewrites[$urlRewriteId])) { goto fe199; } goto D5dee; f13b9: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto Fecf6; E458d: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto b88e7; D5dee: $urls[] = ["\x73\x74\157\x72\145\137\151\144" => $urlRewrite->getStoreId(), "\160\141\x74\150" => $urlRewrite->getRequestPath(), "\x70\x72\151\157\162\x69\164\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_MEDIUM]; goto f13b9; a46bd: E66b2: goto Ad054; Fecf6: fe199: goto a46bd; Ad054: } goto F9f83; fed97: $categoryIds = array_keys($this->categories); goto Ff118; B125a: if (!(null !== $store)) { goto Ba0c7; } goto dda2e; Ae026: if (!count($urls)) { goto d3182; } goto b9201; F0700: $urlRewrites = []; goto B35fa; a50e4: Ba0c7: goto D8df5; fd214: D8d9d: goto Ebf9b; dda2e: $storeId = $store->getStoreId(); goto A3b85; e5e08: if (!count($this->categories)) { goto D8d9d; } goto fed97; B35fa: $urls = []; goto dd43d; A3b85: $this->categoryCollection->setStore($store); goto F483b; Faea9: foreach ($this->categoryCollection as $category) { $this->categories[$category->getId()] = $category; Db8a3: } goto ed6fe; Eccde: $objectManager = $this->getObjectManager(); goto ba063; Ebf9b: } protected function addProductUrls(\Magento\Store\Model\Store $store = null) { goto Ca9b3; C411f: $productStatus = $objectManager->get("\x5c\115\141\147\145\x6e\164\157\134\103\141\x74\x61\x6c\x6f\x67\134\x4d\157\x64\145\154\x5c\x50\162\x6f\x64\x75\x63\x74\134\101\164\164\x72\151\x62\165\164\x65\134\x53\x6f\165\162\x63\x65\x5c\123\x74\141\164\x75\x73"); goto d754a; f2715: F2e0a: goto ec77e; E9e26: $configurableProduct = $objectManager->get("\x5c\x4d\141\147\145\x6e\x74\157\134\x43\157\156\x66\x69\x67\165\x72\x61\x62\x6c\145\120\162\x6f\144\165\143\164\x5c\115\x6f\x64\145\x6c\134\x52\145\x73\157\165\x72\143\x65\x4d\157\144\x65\154\x5c\x50\x72\x6f\x64\165\143\x74\x5c\x54\171\x70\x65\x5c\103\157\x6e\146\151\147\x75\162\141\142\154\x65"); goto C411f; fc7a5: foreach ($this->categories as $category) { goto c374a; d7ef8: a95ff: goto b9338; b0209: if (!count($urls)) { goto b5ae1; } goto D1157; ca819: if (false === empty($entityIds)) { goto b09b6; } goto d84f3; c3b5b: $urls = []; goto d9300; b20ae: $productCollection->setVisibility($productVisibility->getVisibleInSiteIds()); goto D274b; D7cce: cddd6: goto b0209; ac978: $storeId = $store->getStoreId(); goto b2730; A6954: cb3c3: goto f37b5; b4306: b5ae1: goto d7ef8; F545b: if (!(null !== $store)) { goto D0f40; } goto Ff6b2; c9097: Ee7d2: goto ca819; eca03: e01e6: goto d616f; F7852: D0f40: goto D0628; E594a: $entityIds = []; goto Aa1be; d84f3: $break = true; goto A90c7; d616f: $productCollection->clear(); goto F545b; b2730: $urlRewriteCollection->addStoreFilter($storeId, false); goto A6954; F0891: $productCollection->addAttributeToFilter("\x73\x74\141\164\165\163", ["\x69\156" => $productStatus->getVisibleStatusIds()]); goto b20ae; b9338: if ($break == false) { goto e01e6; } goto Cd923; da7c6: if (!(null !== $store)) { goto cb3c3; } goto ac978; Aa1be: foreach ($productCollection as $product) { goto cd993; a5b07: if ("\143\x6f\156\x66\x69\147\x75\162\141\x62\x6c\x65" == $product->getTypeId()) { goto Bbbc2; } goto be042; F796a: $entityIds[$productId] = $productId; goto C0ca5; ccc66: if (isset($productIds[$productId])) { goto c82d9; } goto a5b07; d3051: $productIds[$productId] = $productId; goto dea63; cd993: $productId = $product->getId(); goto ccc66; D5b11: $productIds[$productId] = $productId; goto F796a; c4e62: goto f545e; goto B3944; A7810: ac104: goto f564d; C0ca5: Bf42d: goto c4e62; A9074: f545e: goto A738d; D651f: if (!(true === empty($parentIds))) { goto Bf42d; } goto D5b11; dea63: $entityIds[$productId] = $productId; goto A9074; B3944: Bbbc2: goto d3051; be042: $parentIds = $configurableProduct->getParentIdsByChild($productId); goto D651f; A738d: c82d9: goto A7810; f564d: } goto c9097; d9300: foreach ($urlRewriteCollection as $urlRewrite) { goto Ca110; Fd43d: if (isset($urlRewrites[$urlRewriteId])) { goto f570c; } goto Ee329; Ca110: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto Fd43d; e3752: f570c: goto Fdb29; Ee329: $urls[] = ["\163\164\157\162\145\x5f\x69\144" => $urlRewrite->getStoreId(), "\x70\141\164\150" => $urlRewrite->getRequestPath(), "\160\162\151\157\162\x69\x74\x79" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_LOW]; goto e02dc; e02dc: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto e3752; Fdb29: Dc50d: goto e9644; e9644: } goto D7cce; D1157: $this->numberOfUrls += count($urls); goto bc8f1; Ca367: $i = 0; goto eca03; ee768: $urlRewriteCollection = $objectManager->create("\134\x4d\147\x74\134\126\x61\162\156\151\163\150\134\115\157\x64\145\x6c\134\122\145\x73\157\x75\162\x63\x65\115\x6f\x64\x65\x6c\134\x55\162\154\x52\x65\x77\x72\151\164\x65\x5c\x55\162\154\x52\145\167\162\x69\x74\145\103\157\154\x6c\145\143\164\x69\x6f\x6e"); goto da7c6; aa8e2: $productCollection->setPageSize(self::URL_QUEUE_BATCH_SIZE); goto E594a; d94ee: $productCollection->addAttributeToSelect(["\x65\156\x74\x69\164\171\x5f\x69\x64", "\x73\x74\141\x74\x75\x73"]); goto F0891; Cd923: b2615: goto a0c12; a0c12: e0486: goto E0d3d; eacd0: $urlRewrites = []; goto c3b5b; b199f: $break = false; goto Ca367; A90c7: goto a95ff; goto ef29c; c374a: $productCollection = $objectManager->create("\x5c\x4d\x61\x67\145\156\164\x6f\x5c\x43\x61\x74\x61\154\157\147\134\115\157\144\145\154\134\122\x65\163\x6f\x75\x72\143\145\x4d\x6f\144\145\154\x5c\120\x72\157\144\165\143\164\134\103\157\x6c\x6c\145\x63\164\151\x6f\156"); goto d94ee; f37b5: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_PRODUCT); goto A3c18; Ff6b2: $productCollection->addStoreFilter($store); goto F7852; A3c18: $urlRewriteCollection->addEntityIdFilter($entityIds); goto eacd0; D0628: $productCollection->setCurPage(++$i); goto aa8e2; ef29c: b09b6: goto ee768; D274b: $productCollection->addCategoryFilter($category); goto b199f; bc8f1: $this->urlQueue->addToQueue($urls); goto b4306; E0d3d: } goto de7bd; Ca9b3: if (!count($this->categories)) { goto F2e0a; } goto A7ffb; D9107: $productIds = []; goto fc7a5; de7bd: Ef535: goto f2715; A7ffb: $objectManager = $this->getObjectManager(); goto E9e26; d754a: $productVisibility = $objectManager->get("\134\x4d\x61\x67\x65\x6e\x74\x6f\x5c\103\x61\164\141\x6c\x6f\x67\x5c\x4d\x6f\144\x65\154\x5c\x50\x72\157\x64\x75\x63\164\134\126\151\x73\151\x62\151\x6c\151\x74\171"); goto D9107; ec77e: } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } protected function showStores(OutputInterface $output) { goto d985d; a8203: $table->setHeaders(["\123\x74\x6f\162\x65\x20\x49\104", "\102\x61\163\x65\x20\x55\122\114"]); goto Abea1; d450c: foreach ($stores as $store) { goto b5488; b5488: $row = [$store->getStoreId(), $store->getBaseUrl()]; goto F2ba6; F2ba6: $table->addRow($row); goto F92ed; F92ed: a8c87: goto dbf4b; dbf4b: } goto F6d7a; Abea1: $stores = $this->storeManager->getStores(); goto d450c; F6d7a: aefdd: goto ab86c; ab86c: $table->render($output); goto A8c67; d985d: $table = $this->getHelperSet()->get("\x74\141\142\x6c\x65"); goto a8203; A8c67: } }
