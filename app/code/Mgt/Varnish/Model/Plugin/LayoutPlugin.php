<?php
 namespace Mgt\Varnish\Model\Plugin; class LayoutPlugin { const ADMIN_AREA_CODE = "\141\144\155\151\156\x68\164\x6d\x6c"; protected $request; protected $storeConfig; protected $varnishConfig; protected $response; protected $license; protected $logger; protected $cacheLifetime; protected $state; public function __construct() { goto B421e; bc944: $this->logger = $objectManager->get("\x5c\x50\x73\162\134\x4c\157\x67\134\x4c\157\147\147\x65\162\x49\156\164\x65\x72\x66\141\x63\x65"); goto D65a1; d0ab5: $this->license = $objectManager->get("\134\115\147\x74\134\x56\141\x72\156\151\163\150\134\x4d\x6f\144\145\154\x5c\x4c\151\143\145\x6e\163\x65"); goto edf4c; B421e: $objectManager = $this->getObjectManager(); goto A4db7; D79d5: $this->response = $objectManager->get("\x5c\115\141\147\x65\x6e\164\x6f\134\x46\162\x61\x6d\145\167\x6f\x72\x6b\x5c\101\160\160\x5c\x52\145\163\x70\157\156\163\145\x49\156\164\x65\162\146\141\x63\145"); goto d5fcf; edf4c: $this->state = $objectManager->get("\134\115\141\147\x65\156\x74\157\134\x46\162\x61\155\x65\x77\x6f\x72\x6b\x5c\101\x70\x70\x5c\123\x74\141\164\145"); goto bc944; A4db7: $this->request = $objectManager->get("\x5c\115\141\x67\x65\156\x74\157\134\x46\162\141\x6d\x65\x77\x6f\162\x6b\x5c\101\160\160\x5c\122\145\x71\165\x65\x73\x74\x5c\x48\x74\x74\160"); goto D79d5; C792e: $this->varnishConfig = $objectManager->get("\134\x4d\147\164\134\x56\x61\162\156\151\x73\150\134\x4d\x6f\x64\145\x6c\134\x43\141\x63\150\x65\x5c\x43\157\156\x66\x69\147"); goto d0ab5; d5fcf: $this->storeConfig = $objectManager->get("\x5c\x4d\141\147\x65\156\164\x6f\x5c\x50\141\147\145\x43\x61\x63\x68\x65\x5c\x4d\157\144\145\154\134\103\x6f\156\146\x69\x67"); goto C792e; D65a1: } public function afterGetOutput(\Magento\Framework\View\Layout $subject, $result) { goto Bee27; Eb4d5: $this->saveUrlInformation($tags); goto e3a27; D4173: $this->response->setNoCacheHeaders(); goto B4f07; a2e40: ae271: goto B1abd; E71d9: fdfe6: goto d7862; e3a27: e0b38: goto e8f12; cbc36: $this->setResponseHeaders($tags); goto Eb4d5; d7862: $tags = []; goto c7d56; e8f12: return $result; goto f1264; Eb438: goto e0b38; goto E71d9; B1abd: $tags = array_unique($tags); goto cbc36; D92a1: if (true === $isCacheable) { goto fdfe6; } goto D4173; Bee27: $isCacheable = $this->isCacheable($subject); goto D92a1; c7d56: foreach ($subject->getAllBlocks() as $block) { goto a5332; B26cc: $tags = array_merge($tags, $block->getIdentities()); goto af0d6; D7d1e: goto Febad; goto D74e5; cdb39: $isEsiBlock = $block->getTtl() > 0; goto Be3d5; b6664: if (!($isVarnish && $isEsiBlock)) { goto De85d; } goto D7d1e; Be3d5: $isVarnish = $this->storeConfig->getType() == \Magento\PageCache\Model\Config::VARNISH; goto b6664; af0d6: F7618: goto b1ddf; D74e5: De85d: goto B26cc; b1ddf: Febad: goto a21e1; a5332: if (!$block instanceof \Magento\Framework\DataObject\IdentityInterface) { goto F7618; } goto cdb39; a21e1: } goto a2e40; B4f07: $this->response->setHeader("\130\x2d\x43\x61\143\150\x65\55\114\x69\146\x65\164\151\x6d\x65", 0); goto Eb438; f1264: } protected function isCacheable(\Magento\Framework\View\Layout $subject) { goto c9895; d2159: ba23d: goto a2d67; c0095: if (!(false === $isFullPageCacheEnabled || false === $isVarnishEnabled)) { goto b3462; } goto F6de5; Eeec8: $requestStringWithoutSlash = rtrim($requestString, "\57"); goto fc11d; F6de5: return false; goto Aafec; E8f01: $requestString = ltrim($this->request->getRequestString(), "\x2f"); goto Eeec8; fffe1: $excludedRoutes = $this->varnishConfig->getExcludedRoutes(); goto e48b2; ebb4d: return true; goto E275d; F853f: Fce09: goto E8f01; d280d: foreach ($excludedParams as $param) { goto d6633; d4cec: f6167: goto C4b0e; d784e: return false; goto d4cec; d6633: if (!$this->request->getParam(trim($param))) { goto f6167; } goto d784e; C4b0e: d9bae: goto E003d; E003d: } goto F853f; Cfd41: if (!(false === $hasLicense)) { goto ba23d; } goto af3f3; E4dfd: E8593: goto ac3f5; Aafec: b3462: goto c32bb; a2d67: $excludedParams = $this->varnishConfig->getExcludedParams(); goto d280d; B3d73: $hasLicense = $this->license->hasLicense($currentHost); goto Cfd41; e4ae1: foreach ($excludedUrls as $excludedUrl) { goto Bfb50; b9c96: if (!($excludedUrl && true === in_array($excludedUrl, [$requestStringWithoutSlash, $requestStringWithSlash]))) { goto bc7ab; } goto B5d5a; B5d5a: return false; goto b4c50; B0702: Eef70: goto Ae6f6; Bfb50: $excludedUrl = trim($excludedUrl); goto b9c96; b4c50: bc7ab: goto B0702; Ae6f6: } goto e04eb; C75a8: return false; goto E4dfd; af3f3: return false; goto d2159; d37d4: if (!(false === $isMgt)) { goto a81f8; } goto E01c2; f285a: if (!(true === $isAdminStore)) { goto E8593; } goto C75a8; c32bb: $isAdminStore = $this->isAdminStore(); goto f285a; E4c47: $excludedUrls = $this->varnishConfig->getExcludedUrls(); goto e4ae1; ac3f5: $isMgt = isset($_SERVER["\115\107\x54"]) && $_SERVER["\115\107\x54"] == "\61" ? true : false; goto d37d4; b7e7b: $isVarnishEnabled = $this->varnishConfig->isEnabled(); goto c0095; a36e5: a81f8: goto D0dfd; E01c2: return false; goto a36e5; d100c: cd622: goto ebb4d; e48b2: foreach ($excludedRoutes as $route) { goto e3ff8; Ed5c5: F5924: goto f13e7; e3ff8: $route = trim($route); goto D4865; d2ceb: Bffe0: goto Ed5c5; D4865: if (!(!empty($route) && strpos($fullActionName, $route) === 0)) { goto Bffe0; } goto f812d; f812d: return false; goto d2ceb; f13e7: } goto d100c; D0dfd: $currentHost = isset($_SERVER["\110\124\x54\x50\x5f\x48\x4f\x53\x54"]) ? $_SERVER["\x48\x54\124\x50\137\x48\117\x53\x54"] : ''; goto B3d73; C75ac: $fullActionName = $this->request->getFullActionName(); goto fffe1; c9895: $isFullPageCacheEnabled = $this->storeConfig->isEnabled(); goto b7e7b; fc11d: $requestStringWithSlash = sprintf("\45\163\57", $requestStringWithoutSlash); goto E4c47; e04eb: Cee83: goto C75ac; E275d: } public function setResponseHeaders(array $tags) { goto E2f05; Cbb29: $this->response->setHeader("\130\x2d\x43\141\143\150\145\55\x4c\x69\146\145\164\x69\x6d\x65", $this->cacheLifetime); goto d7742; dc1b7: $this->response->setHeader("\130\x2d\x4d\141\147\145\x6e\164\x6f\x2d\122\157\165\x74\145", $fullActionName); goto Bb5e6; cce89: foreach ($routesCacheLifetime as $routeConfig) { goto A9f69; B83c7: goto Ffa98; goto e669d; F8351: if (!($route && $fullActionName == $route)) { goto C3fb3; } goto fac15; B84d3: a8610: goto A1d68; A9f69: $route = isset($routeConfig["\146\151\x65\154\x64\x31"]) ? trim($routeConfig["\x66\x69\x65\154\144\61"]) : ''; goto B5e1f; B5e1f: $routeCacheLifetime = isset($routeConfig["\146\151\145\x6c\144\62"]) ? $routeConfig["\x66\x69\145\154\x64\62"] : ''; goto F8351; e669d: C3fb3: goto B84d3; fac15: $this->cacheLifetime = $routeCacheLifetime; goto B83c7; A1d68: } goto Cf253; f205c: $fullActionName = $this->request->getFullActionName(); goto B557a; d2b6f: $this->response->setHeader("\130\x2d\x43\141\x63\x68\145\55\104\145\x62\165\147", 1); goto dc1b7; c69a9: $this->response->setPublicHeaders($this->cacheLifetime); goto Cbb29; B557a: $routesCacheLifetime = $this->varnishConfig->getRoutesCacheLifetime(); goto c922a; Bb5e6: b1f23: goto a9359; C7456: A4582: goto c1e10; c922a: if (!($routesCacheLifetime && count($routesCacheLifetime))) { goto A4582; } goto cce89; a9359: $this->response->setHeader("\130\x2d\115\141\x67\145\156\164\157\x2d\124\141\x67\163", implode("\x2c", $tags)); goto c69a9; Cf253: Ffa98: goto C7456; E2f05: $this->cacheLifetime = $this->varnishConfig->getDefaultCacheLifetime(); goto Cacb0; c1e10: if (!(true === $isDebugModeEnabled)) { goto b1f23; } goto d2b6f; Cacb0: $isDebugModeEnabled = $this->varnishConfig->isDebugModeEnabled(); goto f205c; d7742: } protected function saveUrlInformation(array $tags) { goto d771b; c26a2: A5903: goto Df20b; Db62b: if (!(true === $canSaveUrlInformation)) { goto A5903; } goto fc2c7; fc2c7: try { goto Ccd57; Bd72b: if (!($storeBaseUri->getPath() != "\57")) { goto E2765; } goto B00a4; ba7c6: $url->loadByStoreIdAndPath($storeId, $path); goto fb057; ee830: $storeManager = $objectManager->get("\134\x4d\x61\x67\x65\x6e\x74\x6f\134\123\164\x6f\x72\x65\x5c\115\157\144\x65\154\134\123\x74\x6f\x72\x65\115\x61\x6e\x61\x67\145\x72\111\x6e\164\145\162\x66\141\x63\x65"); goto D73f7; Af6b6: $cacheExpiredAt = $cacheExpiredAt->format("\x59\55\155\55\144\x20\110\72\151\72\x73"); goto a22ec; B1d36: $storeBaseUri = new \Zend\Uri\Uri($store->getBaseUrl()); goto f00c1; C0176: $url->setCacheExpiredAt($cacheExpiredAt); goto A4faf; e1352: $url->setPath($path); goto df36c; Ccd57: $objectManager = $this->getObjectManager(); goto ee830; eb0fa: $storeId = $store->getStoreId(); goto B1d36; F5ae3: E2765: goto Ac4f5; A4faf: $url->save(); goto D0b92; bf662: $cacheExpiredAt = new \DateTime("\x6e\x6f\x77", new \DateTimeZone("\x55\124\x43")); goto b6054; b6054: $cacheExpiredAt->add(new \DateInterval(sprintf("\x50\x54\45\x73\x53", $this->cacheLifetime))); goto Af6b6; Cee46: $url->setCacheLifetime($this->cacheLifetime); goto C0176; B912a: $url->delete(); goto b983e; fb057: if (!$url->getId()) { goto c1c85; } goto B912a; df36c: $url->setTags($tags); goto Cee46; a22ec: $url->setStoreId($storeId); goto e1352; c5ff1: c1c85: goto bf662; D73f7: $store = $storeManager->getStore(); goto eb0fa; f00c1: $path = $this->request->getRequestUri(); goto Bd72b; Ac4f5: $url = $objectManager->create("\115\147\164\x5c\x56\141\162\x6e\151\x73\x68\x5c\115\x6f\x64\x65\154\x5c\x55\x72\154"); goto ba7c6; b983e: $url = $objectManager->create("\x4d\147\x74\134\x56\141\162\156\151\x73\150\x5c\115\x6f\144\145\154\x5c\x55\162\x6c"); goto c5ff1; B00a4: $path = "\57" . substr($path, strlen($storeBaseUri->getPath())); goto F5ae3; D0b92: } catch (\Exception $e) { $this->logger->critical($e); } goto c26a2; d771b: $canSaveUrlInformation = $this->canSaveUrlInformation(); goto Db62b; Df20b: } protected function canSaveUrlInformation() { goto dabd6; dc168: $cacheWarmerRoutes = $this->varnishConfig->getCacheWarmerRoutes(); goto ceebc; ceebc: foreach ($cacheWarmerRoutes as $cacheWarmerRoute) { goto D45b4; Db428: $cacheWarmerRouteFound = true; goto E9ac1; E9ac1: goto b591d; goto b85e9; D45b4: if (!($cacheWarmerRoute == $fullActionName)) { goto Bfd2c; } goto Db428; b861a: Eec72: goto f2d2d; b85e9: Bfd2c: goto b861a; f2d2d: } goto Cd557; B9d10: F2494: goto D40c9; f464d: $isCacheWarmerEnabled = $this->varnishConfig->isCacheWarmerEnabled(); goto F8c4d; F2745: $fullActionName = $this->request->getFullActionName(); goto dc168; Feeec: a0ac9: goto f464d; a2203: $requestParams = (array) $this->request->getQuery(); goto D7ded; D40c9: $cacheWarmerRouteFound = false; goto F2745; F8c4d: if (!(false === $isCacheWarmerEnabled)) { goto Bb842; } goto Df1bc; f846a: d6835: goto C6026; D1893: if (!(false === $cacheWarmerRouteFound)) { goto d6835; } goto E80d4; cb5dc: return false; goto Feeec; Cd557: b591d: goto D1893; Bec56: return false; goto B9d10; c16c1: if (!(true === $isAdminStore)) { goto a0ac9; } goto cb5dc; C6026: return true; goto a55d1; E80d4: return false; goto f846a; dabd6: $isAdminStore = $this->isAdminStore(); goto c16c1; af11a: Bb842: goto a2203; Df1bc: return false; goto af11a; D7ded: if (!count($requestParams)) { goto F2494; } goto Bec56; a55d1: } protected function isAdminStore() { $isAdminStore = $this->state->getAreaCode() == self::ADMIN_AREA_CODE; return $isAdminStore; } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } }
