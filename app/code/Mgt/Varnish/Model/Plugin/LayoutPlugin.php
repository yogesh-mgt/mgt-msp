<?php
 namespace Mgt\Varnish\Model\Plugin; class LayoutPlugin { const ADMIN_AREA_CODE = "\141\144\x6d\x69\156\x68\164\x6d\x6c"; protected $request; protected $storeConfig; protected $varnishConfig; protected $response; protected $license; protected $logger; protected $cacheLifetime; protected $state; public function __construct() { goto F1912; F1912: $objectManager = $this->getObjectManager(); goto Be46f; c0107: $this->logger = $objectManager->get("\x5c\x50\163\162\x5c\114\x6f\x67\134\114\157\x67\x67\x65\162\111\156\164\145\x72\146\141\x63\145"); goto ee827; a8cc7: $this->response = $objectManager->get("\134\x4d\141\147\145\x6e\x74\157\x5c\x46\162\x61\x6d\x65\167\x6f\x72\x6b\x5c\x41\x70\x70\x5c\122\145\163\x70\x6f\156\163\x65\x49\x6e\164\x65\162\x66\141\x63\x65"); goto E0eba; E0eba: $this->storeConfig = $objectManager->get("\x5c\x4d\141\147\145\156\x74\x6f\x5c\x50\x61\x67\145\103\141\x63\150\145\134\115\157\x64\x65\154\x5c\103\x6f\x6e\146\x69\x67"); goto B4f6a; Be46f: $this->request = $objectManager->get("\134\x4d\141\147\x65\156\164\157\x5c\x46\x72\x61\x6d\145\167\x6f\x72\x6b\x5c\101\x70\160\134\122\x65\x71\x75\145\x73\164\x5c\110\x74\x74\x70"); goto a8cc7; C3f2f: $this->state = $objectManager->get("\x5c\x4d\141\147\145\156\164\x6f\x5c\106\162\141\x6d\145\x77\157\162\x6b\x5c\101\x70\x70\x5c\123\x74\x61\x74\145"); goto c0107; B4f6a: $this->varnishConfig = $objectManager->get("\134\x4d\147\164\134\x56\141\162\x6e\151\x73\150\134\x4d\157\144\145\x6c\134\103\x61\x63\x68\x65\x5c\x43\157\156\x66\151\x67"); goto f8ea5; f8ea5: $this->license = $objectManager->get("\134\115\x67\164\134\126\x61\x72\x6e\x69\163\150\134\x4d\x6f\144\145\154\x5c\114\x69\x63\x65\x6e\x73\x65"); goto C3f2f; ee827: } public function afterGetOutput(\Magento\Framework\View\Layout $subject, $result) { goto C4713; Ecf5f: $this->response->setHeader("\130\x2d\103\x61\x63\x68\145\55\x4c\151\146\x65\164\x69\x6d\145", 0); goto D4dce; A0c72: $tags = []; goto A3912; Df4b3: $this->saveUrlInformation($tags); goto De451; Ac46d: $this->setResponseHeaders($tags); goto Df4b3; cac80: c6ca5: goto f1f8b; C4713: $isCacheable = $this->isCacheable($subject); goto c90f9; D4dce: goto b7a48; goto A3cae; c90f9: if (true === $isCacheable) { goto F0ae2; } goto D350d; A3912: foreach ($subject->getAllBlocks() as $block) { goto D581f; ba06c: B32c6: goto c38bf; e7566: de9c1: goto ba06c; cbfa5: if (!($isVarnish && $isEsiBlock)) { goto ea638; } goto a47f4; E8f2b: $isVarnish = $this->storeConfig->getType() == \Magento\PageCache\Model\Config::VARNISH; goto cbfa5; a47f4: goto B32c6; goto c7ded; D581f: if (!$block instanceof \Magento\Framework\DataObject\IdentityInterface) { goto de9c1; } goto Af9ea; Bec87: $tags = array_merge($tags, $block->getIdentities()); goto e7566; Af9ea: $isEsiBlock = $block->getTtl() > 0; goto E8f2b; c7ded: ea638: goto Bec87; c38bf: } goto cac80; D350d: $this->response->setNoCacheHeaders(); goto Ecf5f; f1f8b: $tags = array_unique($tags); goto Ac46d; f4b83: return $result; goto B1c93; A3cae: F0ae2: goto A0c72; De451: b7a48: goto f4b83; B1c93: } protected function isCacheable(\Magento\Framework\View\Layout $subject) { goto ee8ab; b5898: E771c: goto b9447; ed7de: Ca7ad: goto dabee; F7773: return false; goto b5898; ec806: $requestStringWithSlash = sprintf("\x25\x73\57", $requestStringWithoutSlash); goto c7efd; D9d6e: $excludedParams = $this->varnishConfig->getExcludedParams(); goto c94b5; dabee: $fullActionName = $this->request->getFullActionName(); goto E97c1; e354d: foreach ($excludedRoutes as $route) { goto Fd669; af2ff: D0396: goto Dd903; Dd903: b82be: goto C10b1; f8e54: return false; goto af2ff; d6ca4: if (!(!empty($route) && strpos($fullActionName, $route) === 0)) { goto D0396; } goto f8e54; Fd669: $route = trim($route); goto d6ca4; C10b1: } goto A0507; f60cf: $isVarnishEnabled = $this->varnishConfig->isEnabled(); goto Dce7b; ad8af: foreach ($excludedUrls as $excludedUrl) { goto c1b36; C6343: return false; goto bdc4b; c1b36: $excludedUrl = trim($excludedUrl); goto dfb11; bdc4b: a2968: goto d0763; dfb11: if (!($excludedUrl && true === in_array($excludedUrl, [$requestStringWithoutSlash, $requestStringWithSlash]))) { goto a2968; } goto C6343; d0763: e15e8: goto cb64e; cb64e: } goto ed7de; ee8ab: $isFullPageCacheEnabled = $this->storeConfig->isEnabled(); goto f60cf; cdfcd: $currentHost = isset($_SERVER["\110\124\x54\120\x5f\x48\x4f\123\x54"]) ? $_SERVER["\110\124\124\120\137\x48\117\123\124"] : ''; goto E8932; Fbc16: $requestStringWithoutSlash = rtrim($requestString, "\57"); goto ec806; c12ba: d48ba: goto Db0bb; E97c1: $excludedRoutes = $this->varnishConfig->getExcludedRoutes(); goto e354d; E8932: $hasLicense = $this->license->hasLicense($currentHost); goto cafc0; f2099: f2459: goto cdfcd; cafc0: if (!(false === $hasLicense)) { goto b4f21; } goto Ae7ca; b03b4: return true; goto b6d47; Db0bb: $requestString = ltrim($this->request->getRequestString(), "\x2f"); goto Fbc16; A0507: E9e7b: goto b03b4; c1613: return false; goto face9; c94b5: foreach ($excludedParams as $param) { goto B654f; de1a9: C7a58: goto E45ad; a6cf1: return false; goto Ad3ad; Ad3ad: a1a83: goto de1a9; B654f: if (!$this->request->getParam(trim($param))) { goto a1a83; } goto a6cf1; E45ad: } goto c12ba; Ae7ca: return false; goto B3d32; face9: B4a94: goto E69a8; Dce7b: if (!(false === $isFullPageCacheEnabled || false === $isVarnishEnabled)) { goto B4a94; } goto c1613; c4c16: if (!(true === $isAdminStore)) { goto E771c; } goto F7773; ce136: return false; goto f2099; A9183: if (!(false === $isMgt)) { goto f2459; } goto ce136; b9447: $isMgt = isset($_SERVER["\115\x47\x54"]) && $_SERVER["\x4d\107\124"] == "\x31" ? true : false; goto A9183; E69a8: $isAdminStore = $this->isAdminStore(); goto c4c16; c7efd: $excludedUrls = $this->varnishConfig->getExcludedUrls(); goto ad8af; B3d32: b4f21: goto D9d6e; b6d47: } public function setResponseHeaders(array $tags) { goto E9807; c2315: C4ed9: goto Fa256; Fa256: if (!(true === $isDebugModeEnabled)) { goto ef4e7; } goto df746; A205d: $fullActionName = $this->request->getFullActionName(); goto b77fb; b77fb: $routesCacheLifetime = $this->varnishConfig->getRoutesCacheLifetime(); goto e5d9a; df746: $this->response->setHeader("\x58\55\103\x61\143\x68\x65\x2d\104\145\x62\x75\x67", 1); goto cc65b; cc65b: $this->response->setHeader("\x58\x2d\x4d\141\147\x65\156\164\157\x2d\x52\157\x75\164\x65", $fullActionName); goto A98ec; d7a7f: foreach ($routesCacheLifetime as $routeConfig) { goto Cd515; F55eb: $this->cacheLifetime = $routeCacheLifetime; goto B5d56; Cd515: $route = isset($routeConfig["\x66\x69\145\154\x64\x31"]) ? trim($routeConfig["\x66\x69\145\154\x64\x31"]) : ''; goto B67f9; df94a: ef3c3: goto Be1f7; B67f9: $routeCacheLifetime = isset($routeConfig["\x66\151\145\x6c\x64\62"]) ? $routeConfig["\x66\x69\x65\154\x64\62"] : ''; goto Ec518; Ec518: if (!($route && $fullActionName == $route)) { goto ef3c3; } goto F55eb; B5d56: goto A1662; goto df94a; Be1f7: e1086: goto d58ad; d58ad: } goto Ccd13; d7456: $this->response->setHeader("\x58\x2d\x4d\x61\147\145\x6e\x74\157\55\124\x61\147\x73", implode("\x2c", $tags)); goto c2e49; a10ad: $isDebugModeEnabled = $this->varnishConfig->isDebugModeEnabled(); goto A205d; D7c17: $this->response->setHeader("\x58\x2d\x43\x61\x63\150\145\55\114\151\x66\x65\x74\x69\155\145", $this->cacheLifetime); goto F0efb; e5d9a: if (!($routesCacheLifetime && count($routesCacheLifetime))) { goto C4ed9; } goto d7a7f; E9807: $this->cacheLifetime = $this->varnishConfig->getDefaultCacheLifetime(); goto a10ad; c2e49: $this->response->setPublicHeaders($this->cacheLifetime); goto D7c17; Ccd13: A1662: goto c2315; A98ec: ef4e7: goto d7456; F0efb: } protected function saveUrlInformation(array $tags) { goto fe9d8; Ff7fb: try { goto B24d3; cf826: $url->save(); goto d9291; Fb65a: $cacheExpiredAt = new \DateTime("\x6e\157\x77", new \DateTimeZone("\125\124\103")); goto de06b; dccaf: $path = $this->request->getRequestUri(); goto e3d62; e3d62: if (!($storeBaseUri->getPath() != "\x2f")) { goto a2609; } goto A73db; ab3fe: $url = $objectManager->create("\115\x67\x74\134\126\141\162\x6e\x69\x73\150\x5c\115\x6f\144\145\154\134\125\162\x6c"); goto d5323; A73db: $path = "\x2f" . substr($path, strlen($storeBaseUri->getPath())); goto Ee33a; Df2c7: $storeId = $store->getStoreId(); goto e9e00; d5323: D564f: goto Fb65a; E54c2: $url = $objectManager->create("\x4d\147\164\134\126\141\x72\156\x69\x73\x68\134\115\157\144\145\x6c\x5c\125\162\x6c"); goto Cfa6f; e9e00: $storeBaseUri = new \Laminas\Uri\Uri($store->getBaseUrl()); goto dccaf; de06b: $cacheExpiredAt->add(new \DateInterval(sprintf("\120\124\x25\163\x53", $this->cacheLifetime))); goto b58aa; D20ff: $url->setPath($path); goto f905d; Ee33a: a2609: goto E54c2; f905d: $url->setTags($tags); goto D2d0a; b58aa: $cacheExpiredAt = $cacheExpiredAt->format("\x59\55\x6d\55\144\x20\110\x3a\151\72\x73"); goto ce461; e5a11: $storeManager = $objectManager->get("\x5c\x4d\x61\x67\x65\156\x74\x6f\134\x53\164\x6f\162\145\x5c\x4d\x6f\144\145\x6c\134\123\x74\x6f\x72\x65\115\x61\x6e\141\147\x65\162\x49\156\x74\145\162\x66\x61\x63\145"); goto a64c2; D2d0a: $url->setCacheLifetime($this->cacheLifetime); goto C008d; C008d: $url->setCacheExpiredAt($cacheExpiredAt); goto cf826; B24d3: $objectManager = $this->getObjectManager(); goto e5a11; E5bb1: if (!$url->getId()) { goto D564f; } goto Bab4c; Cfa6f: $url->loadByStoreIdAndPath($storeId, $path); goto E5bb1; Bab4c: $url->delete(); goto ab3fe; ce461: $url->setStoreId($storeId); goto D20ff; a64c2: $store = $storeManager->getStore(); goto Df2c7; d9291: } catch (\Exception $e) { $this->logger->critical($e); } goto a699c; d84be: if (!(true === $canSaveUrlInformation)) { goto E1a4f; } goto Ff7fb; fe9d8: $canSaveUrlInformation = $this->canSaveUrlInformation(); goto d84be; a699c: E1a4f: goto ae51e; ae51e: } protected function canSaveUrlInformation() { goto D726b; fe835: if (!(false === $isCacheWarmerEnabled)) { goto bf0df; } goto F9ae3; C6e08: return false; goto c999c; Ffcf0: $fullActionName = $this->request->getFullActionName(); goto Aafc3; A76f5: foreach ($cacheWarmerRoutes as $cacheWarmerRoute) { goto A0709; c5843: $cacheWarmerRouteFound = true; goto Aae43; A0709: if (!($cacheWarmerRoute == $fullActionName)) { goto F2893; } goto c5843; bc48c: F2893: goto a5a0e; a5a0e: E831d: goto d9bce; Aae43: goto c167a; goto bc48c; d9bce: } goto d0aaf; D7350: bf0df: goto a5047; C301b: if (!(true === $isAdminStore)) { goto cfcf6; } goto E9a46; A6c97: if (!count($requestParams)) { goto D7ab6; } goto C6e08; d0aaf: c167a: goto edaf0; E3a93: $cacheWarmerRouteFound = false; goto Ffcf0; d352d: cfcf6: goto E7fc4; b980f: return false; goto Cba70; Cba70: d53ca: goto f69e0; edaf0: if (!(false === $cacheWarmerRouteFound)) { goto d53ca; } goto b980f; E9a46: return false; goto d352d; E7fc4: $isCacheWarmerEnabled = $this->varnishConfig->isCacheWarmerEnabled(); goto fe835; Aafc3: $cacheWarmerRoutes = $this->varnishConfig->getCacheWarmerRoutes(); goto A76f5; f69e0: return true; goto C6863; D726b: $isAdminStore = $this->isAdminStore(); goto C301b; a5047: $requestParams = (array) $this->request->getQuery(); goto A6c97; F9ae3: return false; goto D7350; c999c: D7ab6: goto E3a93; C6863: } protected function isAdminStore() { $isAdminStore = $this->state->getAreaCode() == self::ADMIN_AREA_CODE; return $isAdminStore; } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } }
