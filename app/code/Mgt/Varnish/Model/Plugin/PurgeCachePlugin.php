<?php
 namespace Mgt\Varnish\Model\Plugin; use Laminas\Uri\Uri; class PurgeCachePlugin extends \Magento\CacheInvalidate\Model\PurgeCache { const REQUEST_TIMEOUT = 5; protected $coreLogger; protected $logger; protected $varnishConfig; protected $urlCollection; protected $objectManager; protected static $tagsRegistry = []; public function __construct(\Magento\PageCache\Model\Cache\Server $cacheServer, \Magento\CacheInvalidate\Model\SocketFactory $socketAdapterFactory, \Mgt\Varnish\Model\Cache\Config $varnishConfig, \Mgt\Varnish\Model\ResourceModel\Url\Collection $urlCollection, \Magento\Framework\ObjectManagerInterface $objectManager, \Psr\Log\LoggerInterface $coreLogger, \Mgt\Varnish\Model\Logger\Logger $logger) { goto E5818; ea0d4: $this->varnishConfig = $varnishConfig; goto fe9e7; b3589: $this->socketAdapterFactory = $socketAdapterFactory; goto ea0d4; Aa4e6: $this->logger = $logger; goto E0337; B9458: $this->coreLogger = $coreLogger; goto Aa4e6; Cbed1: $this->urlCollection = $urlCollection; goto B9458; fe9e7: $this->objectManager = $objectManager; goto Cbed1; E5818: $this->cacheServer = $cacheServer; goto b3589; E0337: } public function sendPurgeRequest($tagsPattern) { goto f91c8; a0801: switch ($tagsPattern) { case "\x2e\52": $logMessage = "\124\x68\x65\40\x77\150\157\x6c\x65\x20\x56\x61\x72\156\151\163\150\x20\x43\141\143\x68\x65\40\x68\141\163\40\x62\x65\x65\156\x20\x70\165\162\x67\145\144"; goto b8d62; } goto e9ba8; c8bad: foreach ($tagsPattern as $tag) { goto Ee69c; d4398: $tags[] = $tag; goto A1e78; C2349: A085a: goto d834a; A1e78: self::$tagsRegistry[$tag] = $tag; goto D9aba; D9aba: d3df0: goto C2349; Ee69c: if (isset(self::$tagsRegistry[$tag])) { goto d3df0; } goto d4398; d834a: } goto F711d; e1071: $pattern = "\50\50\136\x7c\54\51\x25\163\x28\54\x7c\x24\x29\x29"; goto Ae434; cf48a: goto Da46f; goto F3cd2; e9ba8: D4b90: goto d9d64; d9d64: b8d62: goto cf48a; a7443: if ($tags) { goto c1c90; } goto d9bb2; ebcc0: if (!(true === $isCacheWarmerEnabled)) { goto Bb848; } goto B335d; B4d0b: $this->_sendPurgeRequest($headers); goto ca9a6; B335d: $this->addToQueue($tags); goto bca32; fe3a3: $logMessage = sprintf("\126\x61\162\x6e\151\163\x68\x20\x43\141\x63\x68\145\x20\x70\x75\162\x67\x65\144\40\142\171\40\146\x6f\154\154\x6f\167\x69\x6e\x67\x20\x74\x61\x67\x73\x3a\x20\x25\163", print_r($tags, true)); goto Df4d5; Df4d5: $tagsPattern = implode("\x7c", array_unique($tagsPattern)); goto C67bc; ddbf2: foreach ($tags as $tag) { $tagsPattern[] = sprintf($pattern, $tag); e1bef: } goto Cbc6b; F711d: B841d: goto a7443; ca9a6: $isCacheWarmerEnabled = $this->varnishConfig->isCacheWarmerEnabled(); goto ebcc0; C2a77: c1c90: goto e1071; bca32: Bb848: goto B3747; B3747: $this->logMessage($logMessage); goto e8636; d9bb2: return true; goto C2a77; C67bc: Da46f: goto dfad7; D3d36: if (true === is_array($tagsPattern)) { goto ef9b9; } goto a2b1a; Ae434: $tagsPattern = []; goto ddbf2; e8636: return true; goto ab7f3; a2b1a: $logMessage = ''; goto a0801; F3cd2: ef9b9: goto c8bad; dfad7: $headers = [self::HEADER_X_MAGENTO_TAGS_PATTERN => $tagsPattern]; goto B4d0b; Cbc6b: f899c: goto fe3a3; f91c8: $tags = []; goto D3d36; ab7f3: } public function addToQueue(array $tags) { goto E42eb; d63c1: Ee192: goto fcf41; Ed038: try { goto Af8ff; D6ead: $this->urlCollection->addTagsFilter($tags); goto ed816; ed816: foreach ($this->urlCollection as $url) { $urls[] = ["\163\x74\x6f\162\145\x5f\x69\144" => $url->getStoreId(), "\160\141\164\150" => $url->getPath(), "\160\162\x69\x6f\x72\x69\164\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_HIGH]; cd4fb: } goto b3cd8; e2c19: if (!count($urls)) { goto c3fd7; } goto B81bb; F4de1: $urlQueue->addToQueue($urls); goto b9b81; Af8ff: $urls = []; goto D6ead; b9b81: c3fd7: goto b676c; B81bb: $urlQueue = $this->objectManager->create("\115\x67\x74\x5c\x56\x61\162\156\151\163\150\x5c\x4d\x6f\x64\145\154\134\125\x72\154\121\x75\145\x75\x65"); goto F4de1; b3cd8: F8bbf: goto e2c19; b676c: } catch (\Exception $e) { $errorMessage = sprintf("\101\156\x20\145\162\x72\x6f\162\x20\x6f\143\x63\165\x72\162\x65\x64\40\144\165\x72\151\156\147\x20\141\x64\144\x69\x6e\147\x20\x74\x6f\40\161\x75\145\165\x65\54\x20\145\162\162\157\162\x20\155\145\x73\163\x61\x67\145\x3a\x20\x25\x73", $e->getMessage()); $this->coreLogger->error($errorMessage); } goto d63c1; E42eb: if (!count($tags)) { goto Ee192; } goto Ed038; fcf41: } public function purgeStoreRequest(\Magento\Store\Model\Store $store) { goto e9962; e9962: $uri = new Uri($store->getBaseUrl()); goto ced58; fd59e: $this->logMessage($logMessage); goto Aa6a6; Eb982: $this->_sendPurgeRequest($headers); goto Ba2cd; ced58: $headers = ["\x48\117\123\124" => $uri->getHost()]; goto Eb982; Ba2cd: $logMessage = sprintf("\123\164\157\x72\145\x20\167\x69\164\150\x20\x62\141\x73\x65\x20\165\162\154\x3a\x20\45\163\40\50\111\x44\72\40\45\x73\x29\x20\x68\x61\x73\x20\x62\x65\x65\x6e\40\160\165\162\147\x65\x64", $store->getBaseUrl(), $store->getStoreId()); goto fd59e; Aa6a6: } public function purgeUrlRequest($url) { goto cc51e; D7817: $logMessage = sprintf("\x55\x72\154\72\40\45\163\x20\x68\141\x73\40\142\x65\x65\156\40\160\165\162\x67\x65\x64", $url); goto b28b1; Effcf: $headers = ["\110\x4f\x53\x54" => $uri->getHost()]; goto B14be; cc51e: $uri = new Uri($url); goto Effcf; b28b1: $this->logMessage($logMessage); goto cc918; B14be: $this->_sendPurgeRequest($headers, $uri->getPath()); goto D7817; cc918: } protected function _sendPurgeRequest(array $headers, $path = null) { goto Fdb0b; edb3b: $servers = $this->getCacheServers(); goto C80d3; C80d3: foreach ($servers as $server) { try { goto a0da4; ee1f9: F0e32: goto E891d; a0da4: if (!(null !== $path)) { goto F0e32; } goto a999a; e075b: $socketAdapter->close(); goto B4e7e; E891d: $socketAdapter->connect($server->getHost(), $server->getPort()); goto Ff065; a999a: $server->setPath($path); goto ee1f9; Ff065: $socketAdapter->write("\120\x55\122\x47\105", $server, "\x31\x2e\61", $headers); goto e075b; B4e7e: } catch (\Exception $e) { goto dedde; f19b0: throw new \Exception($errorMessage); goto Fd2b4; B5c86: $this->logMessage($errorMessage, true); goto f19b0; dedde: $errorMessage = sprintf("\x41\156\40\x65\x72\x72\x6f\x72\40\157\143\x63\165\x72\x72\x65\x64\x20\144\165\162\151\156\147\x20\160\165\162\147\151\x6e\x67\x2c\x20\145\x72\162\157\x72\x20\155\145\163\163\x61\147\x65\72\x20\x22\45\163\42", $e->getMessage()); goto B5c86; Fd2b4: } E4d65: } goto E7a08; d8639: $socketAdapter->setOptions(["\164\151\x6d\x65\157\165\164" => self::REQUEST_TIMEOUT]); goto edb3b; E7a08: F32a9: goto Ff5d3; Fdb0b: $socketAdapter = $this->socketAdapterFactory->create(); goto d8639; Ff5d3: } protected function logMessage($message, $force = false) { goto Ed273; e8ff0: if (!(true === $isDebugModeEnabled || true === $force)) { goto eb3a8; } goto a41c3; a41c3: $this->logger->debug($message); goto Bcdc7; Bcdc7: eb3a8: goto c4439; Ed273: $isDebugModeEnabled = $this->varnishConfig->isDebugModeEnabled(); goto e8ff0; c4439: } protected function getCacheServers() { goto cf083; cdd7b: b0573: goto C6ccc; cf083: $cacheServers = []; goto F7e6a; F7e6a: $serverList = $this->varnishConfig->getServerList(); goto b4adb; C6ccc: return $cacheServers; goto B8d71; b4adb: foreach ($serverList as $server) { goto f5c27; F090f: $cacheServers[] = $uri; goto c86c7; Bba80: $uri->setPort($port); goto Db6be; c86c7: a269d: goto C7fd4; c0a04: $uri->setScheme("\150\x74\164\160"); goto Debad; Db6be: $uri->setPath("\57"); goto c0a04; ec726: $uri->setHost($host); goto Bba80; Bdff0: $uri = new Uri(); goto ec726; f5c27: list($host, $port) = explode("\x3a", $server); goto Bdff0; Debad: $uri->setQuery(null); goto F090f; C7fd4: } goto cdd7b; B8d71: } }
