<?php
 namespace Mgt\Waf\Model\Plugin; use Magento\Backend\Setup\ConfigOptionsList as BackendConfigOptionsList; use Mgt\Waf\Model\Aws\Waf as AwsWaf; use Mgt\Waf\Model\Util\Retry; class Waf { const MGT_WAF_CONFIG_DATA = "\155\x67\x74\127\141\146\x43\157\156\146\151\147\x44\x61\x74\141"; const MGT_WAF_CONFIG_DATA_SECTION = "\155\x67\x74\x5f\x77\x61\x66"; const MAGENTO_BACKEND_RESTRICTION_ENABLED = 1; const MAGENTO_BACKEND_RESTRICTION_DISABLED = 0; const MAGENTO_BACKEND_RESTRICTION_ACTION_ALLOW = "\x41\x6c\x6c\157\x77"; const MAGENTO_BACKEND_RESTRICTION_ACTION_BLOCK = "\x42\x6c\x6f\x63\153"; protected $awsWaf; protected $configData = []; protected $awsAccessKey; protected $awsSecretAccessKey; protected $awsRegion; protected $blockedIps = []; protected $blockedCountryCodes = []; protected $blockedIpsIpv4 = []; protected $blockedIpsIpv6 = []; protected $blockedBots = []; protected $webAcl; protected $webAclName; protected $rateLimit; protected $rateLimitWhitelistedIps = []; protected $rateLimitWhitelistedIpsIpv4 = []; protected $rateLimitWhitelistedIpsIpv6 = []; protected $isMagentoBackendRestricted = false; protected $magentoBackendWhitelistedIps = []; protected $magentoBackendWhitelistedIpIpv4 = []; protected $magentoBackendWhitelistedIpIpv6 = []; protected $projectName; protected $deploymentConfig; protected $remoteAddress; protected $session; public function __construct(\Magento\Backend\Model\Session $session, \Magento\Framework\App\DeploymentConfig $deploymentConfig, \Magento\Framework\HTTP\PhpEnvironment\RemoteAddress $remoteAddress) { goto eaf51; bf1de: $this->deploymentConfig = $deploymentConfig; goto d379e; d379e: $this->remoteAddress = $remoteAddress; goto Ce128; eaf51: $this->session = $session; goto bf1de; Ce128: } public function beforeSave(\Magento\Config\Model\Config $subject) { try { goto De549; B3683: if (!(true === isset($this->configData["\x73\x65\x63\x74\x69\x6f\156"]) && $this->configData["\163\145\x63\164\151\157\156"] == self::MGT_WAF_CONFIG_DATA_SECTION)) { goto Bedd5; } goto e67dc; e973f: return; goto c863b; De549: $this->configData = $subject->getData(); goto B3683; Af242: if (!(false === $isMgt)) { goto A3079; } goto e973f; D9693: Bedd5: goto f7fb4; c863b: A3079: goto ba149; e501d: $this->updateWaf(); goto D9693; ba149: $this->session->unsetData(self::MGT_WAF_CONFIG_DATA); goto E22b2; e67dc: $isMgt = true === isset($_SERVER["\x4d\107\124"]) && $_SERVER["\x4d\107\124"] == "\61" ? true : false; goto Af242; E22b2: $this->validate(); goto e501d; f7fb4: } catch (\Exception $e) { $this->session->setData(self::MGT_WAF_CONFIG_DATA, $this->configData); throw $e; } } protected function validate() { goto A402a; Ddd8e: $this->validateMagentoBackendWhitelistedIps(); goto a7c10; Ce03c: $this->validateWebAcl(); goto e17ee; e17ee: $this->validateBlockedIps(); goto f4087; A402a: $this->validateAccessKeys(); goto Ce03c; c964f: $this->validateRateLimitWhitelistIps(); goto Ddd8e; f4087: $this->validateRateLimit(); goto c964f; a7c10: } protected function updateWaf() { try { goto Ca3a4; a60df: $awsWaf->updateWebAcl($webAcl); goto dcc19; Ca3a4: $webAclName = $this->getWebAclName(); goto E4b86; ff4c1: $awsWaf = $this->getAwsWaf(); goto a60df; b5063: $this->updateMagentoBackend(); goto bd2cb; bd2cb: $webAcl = $this->getWebAcl(); goto ff4c1; b6447: $this->updateBlockedIpsIpSets(); goto b62ed; b62ed: $this->updateBlockedBots(); goto b9497; b9497: $this->updateRateLimitValue(); goto F10ca; F10ca: $this->updateRateLimitWhitelistedIpSets(); goto b5063; E4b86: $this->updateBlockedCountryCodes(); goto b6447; dcc19: } catch (\Exception $e) { $errorMessage = sprintf("\x55\x6e\x61\142\154\x65\40\x74\x6f\40\165\160\144\x61\x74\x65\40\127\145\x62\x20\101\x43\114\40\42\45\163\42\x2c\x20\145\x72\162\x6f\x72\x20\155\x65\163\x73\x61\x67\x65\72\x20\x22\x25\163\42\56", $webAclName, $e->getMessage()); throw new \Exception($errorMessage); } } protected function validateAccessKeys() { try { goto f50e3; D0d4e: $this->retry(function () use($wafClient) { $wafClient->listIPSets(["\123\x63\x6f\x70\145" => AwsWaf::SCOPE_REGIONAL]); }); goto f2ea1; f50e3: $awsWaf = $this->getAwsWaf(); goto A913a; A913a: $wafClient = $awsWaf->getWafClient(); goto D0d4e; f2ea1: } catch (\Exception $e) { $errorMessage = sprintf("\101\x57\123\x20\103\162\145\144\145\x6e\164\151\141\154\x73\x20\141\162\145\x20\x6e\x6f\164\x20\166\x61\x6c\x69\144\x2e"); throw new \Exception($errorMessage); } } protected function validateWebAcl() { goto Bd7b9; C94e2: Ee4ef: goto d57e4; F3f22: $errorMessage = sprintf("\x57\145\x62\40\x41\143\x6c\40\42\x25\163\42\40\144\x6f\145\x73\40\x6e\157\x74\40\145\170\x69\x73\164\x20\x69\156\x20\x41\x57\123\x20\x52\145\x67\151\157\x6e\40\42\x25\x73\x22\x2e", $webAclName, $awsRegion); goto C57b9; fd385: if (!(false === empty($webAcls))) { goto Ee4ef; } goto E71b5; c6225: Ca0e0: goto C94e2; Bd7b9: $webAclFound = false; goto Ba140; e35d7: $awsWaf = $this->getAwsWaf(); goto a38ea; C57b9: throw new \Exception($errorMessage); goto a9867; a38ea: $webAcls = $awsWaf->getWebAcls(); goto fd385; Ba140: $webAclName = $this->getWebAclName(); goto e35d7; a9867: Ff3b5: goto C3daf; d57e4: if (!(false === $webAclFound)) { goto Ff3b5; } goto cdc50; cdc50: $awsRegion = $this->getAwsRegion(); goto F3f22; E71b5: foreach ($webAcls as $webAcl) { goto e47c2; df296: cd75d: goto B1c03; e47c2: if (!(true === isset($webAcl["\x4e\x61\155\145"]) && $webAclName == $webAcl["\116\x61\155\x65"])) { goto cd75d; } goto c00ee; f4b10: goto Ca0e0; goto df296; B1c03: ecce5: goto b2230; c00ee: $webAclFound = true; goto f4b10; b2230: } goto c6225; C3daf: } protected function validateBlockedIps() { goto Bf22f; C6943: foreach ($blockedIps as $ip) { goto C14a0; C4bc3: Dd774: goto f5f9e; c1365: B659d: goto F5e2a; f5f9e: goto B659d; goto bacd8; bacd8: E3c33: goto fac91; b6d71: $this->blockedIpsIpv4[] = $ip; goto C4bc3; C14a0: if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) { goto E3c33; } goto a4ac6; E47eb: goto Dd774; goto B37d1; fac91: $this->blockedIpsIpv6[] = $ip; goto c1365; B37d1: c58c6: goto b6d71; a4ac6: if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) { goto c58c6; } goto Bfcb5; F5e2a: a5173: goto Ccf24; Bfcb5: throw new \Exception(sprintf("\x42\154\x6f\143\x6b\145\x64\40\111\120\x20\x22\45\163\x22\x20\x69\163\40\156\x6f\164\40\x76\141\154\151\x64\56", $ip)); goto E47eb; Ccf24: } goto C025a; C025a: Fbb9c: goto C47aa; Fde88: if (!(false === empty($blockedIps))) { goto ab02e; } goto C6943; C47aa: ab02e: goto B9f2f; Bf22f: $blockedIps = $this->getBlockedIps(); goto Fde88; B9f2f: } protected function validateRateLimitWhitelistIps() { goto A9a1f; df744: foreach ($rateLimitWhitelistedIps as $ip) { goto Ba069; ea0f9: $this->rateLimitWhitelistedIpsIpv4[] = $ip; goto Ae918; F957b: $this->rateLimitWhitelistedIpsIpv6[] = $ip; goto bd242; f067b: goto C7255; goto d541b; B26d9: if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) { goto Bf35e; } goto E2ebf; d541b: eaa2a: goto F957b; bd242: C7255: goto fc355; Ae918: a2db0: goto f067b; fc355: Feb69: goto b847d; Ba069: if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) { goto eaa2a; } goto B26d9; bf28b: Bf35e: goto ea0f9; E2ebf: throw new \Exception(sprintf("\122\x61\164\145\x20\114\x69\x6d\x69\164\x20\127\150\x69\x74\145\154\151\x73\x74\x65\144\40\x49\120\x20\42\45\x73\42\x20\x69\163\40\156\157\164\40\166\x61\x6c\x69\144\56", $ip)); goto a7110; a7110: goto a2db0; goto bf28b; b847d: } goto Bc8c8; Ff71f: d94f8: goto fdacc; A9a1f: $rateLimitWhitelistedIps = $this->getRateLimitWhitelistedIps(); goto Bf894; Bf894: if (!(false === empty($rateLimitWhitelistedIps))) { goto d94f8; } goto df744; Bc8c8: ed9dc: goto Ff71f; fdacc: } protected function validateMagentoBackendWhitelistedIps() { goto Ef94a; d4794: foreach ($magentoBackendWhitelistedIps as $ip) { goto B4583; B6efa: Ae869: goto F02d7; E16ae: if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) { goto Ae869; } goto d724d; a9e23: goto A6b8e; goto B6efa; ba01e: B4e52: goto F1f3e; B4583: if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) { goto a838d; } goto E16ae; E4e7c: A6b8e: goto e8152; B1245: A452f: goto ba01e; d724d: throw new \Exception(sprintf("\115\141\147\x65\156\164\x6f\x20\x42\x61\143\x6b\x65\156\144\x20\127\x68\x69\164\x65\154\151\163\164\x65\144\40\111\120\40\42\x25\x73\42\x20\151\x73\x20\156\157\164\40\x76\141\x6c\151\144\56", $ip)); goto a9e23; d8fee: $this->magentoBackendWhitelistedIpIpv6[] = $ip; goto B1245; e8152: goto A452f; goto a5d96; a5d96: a838d: goto d8fee; F02d7: $this->magentoBackendWhitelistedIpIpv4[] = $ip; goto E4e7c; F1f3e: } goto f2d9f; Ef94a: $magentoBackendWhitelistedIps = $this->getMagentoBackendWhitelistedIps(); goto ee7aa; f2d9f: Efc35: goto bf180; ee7aa: if (!(false === empty($magentoBackendWhitelistedIps))) { goto f25a0; } goto d4794; bf180: f25a0: goto fd4e6; fd4e6: } protected function validateRateLimit() { goto E6d8e; d279f: if (!($rateLimit < 100 || $rateLimit > 15000)) { goto ece38; } goto D77b0; E6d8e: $rateLimit = $this->getRateLimit(); goto d279f; D77b0: throw new \Exception(sprintf("\x52\141\x74\145\40\x4c\151\x6d\x69\164\40\42\x25\x73\x22\x20\x6e\157\x74\x20\x76\x61\154\151\x64\54\x20\155\x75\163\164\x20\x62\145\x20\x62\145\164\167\x65\x65\x6e\x20\61\60\x30\40\x61\x6e\x64\40\x31\65\x30\x30\x30\x2e", $rateLimit)); goto B8e3d; B8e3d: ece38: goto C61bd; C61bd: } protected function updateMagentoBackend() { goto A585d; Cc6d7: $webAclRuleArrayIndex = $this->getWebAclRuleArrayIndex($webAclRuleName); goto c4db6; ebdd5: $webAclRuleName = $awsWaf->getWebAclRuleName(AwsWaf::WEB_ACL_RULE_ALLOW_MAGENTO_BACKEND_ACCESS_IPV6); goto aaa78; Be609: ad9d2: goto dc7b3; aec93: $customerIp = $this->remoteAddress->getRemoteAddress(); goto Fda7b; Ed6f2: $backendFrontName = $this->getBackendFrontName(); goto bc374; aaa78: $webAclRuleArrayIndex = $this->getWebAclRuleArrayIndex($webAclRuleName); goto a1ec8; aa5d4: ec49d: goto D57cf; f9046: $webAclRuleArrayIndex = $this->getWebAclRuleArrayIndex($webAclRuleName); goto bab94; b2d3a: goto bd061; goto c70d7; B0aa6: $action = true === $isMagentoBackendRestricted ? self::MAGENTO_BACKEND_RESTRICTION_ACTION_BLOCK : self::MAGENTO_BACKEND_RESTRICTION_ACTION_ALLOW; goto cd170; f3e93: c28bd: goto ebdd5; cd170: $this->webAcl["\x52\x75\x6c\x65\163"][$webAclRuleArrayIndex]["\101\x63\x74\151\x6f\x6e"][$action] = []; goto D9fc8; bf3b8: $webAclRuleName = $awsWaf->getWebAclRuleName(AwsWaf::WEB_ACL_RULE_ALLOW_MAGENTO_BACKEND_ACCESS_IPV4); goto f9046; b0e66: $this->magentoBackendWhitelistedIpIpv4[] = $customerIp; goto b2d3a; e47d5: if (!(true === isset($this->webAcl["\122\x75\154\x65\163"][$webAclRuleArrayIndex]["\101\x63\x74\x69\x6f\156"]))) { goto f17e5; } goto b0f85; D2767: B03e6: goto bf3b8; f765b: $awsWaf->updateIpSet(AwsWaf::IP_SET_MAGENTO_BACKEND_WHITELISTED_IPV6, $this->magentoBackendWhitelistedIpIpv6); goto a328e; c4db6: if (!(true === isset($this->webAcl["\x52\x75\x6c\x65\163"][$webAclRuleArrayIndex]))) { goto B03e6; } goto D0317; A585d: $awsWaf = $this->getAwsWaf(); goto Ed6f2; bab94: if (!(true === isset($this->webAcl["\x52\165\154\x65\163"][$webAclRuleArrayIndex]))) { goto c28bd; } goto Ccf43; a1ec8: if (!(true === isset($this->webAcl["\x52\165\154\145\x73"][$webAclRuleArrayIndex]))) { goto fad99; } goto Aa6bf; D9fc8: $this->webAcl["\122\x75\154\145\163"][$webAclRuleArrayIndex]["\x53\164\141\x74\145\155\x65\x6e\164"]["\x42\x79\164\145\x4d\141\164\143\150\x53\164\141\x74\x65\155\145\156\x74"]["\x53\145\141\x72\143\150\x53\164\162\151\156\x67"] = $backendFrontName; goto D2767; Aef7e: if (!(true === $isMagentoBackendRestricted)) { goto ec49d; } goto aec93; c70d7: A9277: goto f6f19; Aa6bf: $this->webAcl["\122\x75\154\x65\x73"][$webAclRuleArrayIndex]["\x53\x74\x61\x74\x65\x6d\x65\156\x74"]["\x41\x6e\144\x53\164\141\164\145\x6d\145\x6e\164"]["\x53\164\141\x74\x65\155\x65\x6e\164\x73"][0]["\102\x79\x74\x65\115\x61\x74\x63\150\x53\x74\x61\164\145\155\x65\x6e\164"]["\123\145\x61\162\143\150\x53\x74\162\151\x6e\x67"] = $backendFrontName; goto d0650; D0317: $isMagentoBackendRestricted = $this->isMagentoBackendRestricted(); goto e47d5; c9b0d: $awsWaf->updateIpSet(AwsWaf::IP_SET_MAGENTO_BACKEND_WHITELISTED_IPV4, $this->magentoBackendWhitelistedIpIpv4); goto f765b; bc374: $webAclRuleName = $awsWaf->getWebAclRuleName(AwsWaf::WEB_ACL_RULE_BLOCK_MAGENTO_BACKEND_ACCESS); goto Cc6d7; dc7b3: foreach ($this->magentoBackendWhitelistedIpIpv6 as &$ip) { $ip = sprintf("\45\x73\x2f\61\x32\70", $ip); ac0f5: } goto b5160; f6f19: $this->magentoBackendWhitelistedIpIpv6[] = $customerIp; goto f13f3; f13f3: bd061: goto C9ed9; b0f85: unset($this->webAcl["\x52\x75\x6c\145\163"][$webAclRuleArrayIndex]["\101\143\x74\151\x6f\156"]); goto F8936; c5b98: if (filter_var($customerIp, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6)) { goto A9277; } goto b0e66; Fda7b: if (!(false === empty($customerIp))) { goto ff7e8; } goto c5b98; D57cf: foreach ($this->magentoBackendWhitelistedIpIpv4 as &$ip) { $ip = sprintf("\45\x73\x2f\63\62", $ip); Dcabe: } goto Be609; Ccf43: $this->webAcl["\x52\x75\154\x65\163"][$webAclRuleArrayIndex]["\123\164\x61\x74\145\155\145\x6e\x74"]["\101\x6e\144\123\164\x61\x74\145\x6d\x65\156\x74"]["\x53\x74\141\x74\145\155\145\x6e\x74\x73"][0]["\102\171\x74\145\x4d\141\x74\x63\150\123\164\141\x74\x65\x6d\145\156\x74"]["\x53\x65\141\x72\x63\150\x53\164\x72\x69\156\x67"] = $backendFrontName; goto f3e93; d0650: fad99: goto Fb35e; C9ed9: ff7e8: goto aa5d4; F8936: f17e5: goto B0aa6; Fb35e: $isMagentoBackendRestricted = $this->isMagentoBackendRestricted(); goto Aef7e; b5160: e594e: goto c9b0d; a328e: } protected function updateBlockedCountryCodes() { goto Bce05; ab6b9: $blockedCountryCodes = ["\124\x56"]; goto b7e5a; b7e5a: d859a: goto f1681; C30f6: fe40e: goto E7c14; Fd186: throw new \Exception(sprintf("\127\145\x62\40\x41\103\x4c\x20\122\165\154\x65\40\x22\x25\163\x22\40\156\157\164\x20\x66\157\165\x6e\144\56", $webAclRuleName)); goto E03fb; bd241: f790d: goto Ea087; f641a: if (!(true === empty($blockedCountryCodes))) { goto d859a; } goto ab6b9; d8827: $webAclRuleArrayIndex = $this->getWebAclRuleArrayIndex($webAclRuleName); goto d7a78; d7a78: if (true === isset($this->webAcl["\x52\165\x6c\145\x73"][$webAclRuleArrayIndex])) { goto f790d; } goto Fd186; Ea087: $this->webAcl["\x52\165\x6c\x65\x73"][$webAclRuleArrayIndex]["\x53\x74\141\164\145\x6d\x65\x6e\x74"]["\107\x65\157\x4d\141\164\x63\150\123\x74\x61\164\x65\155\x65\156\164"]["\103\x6f\x75\x6e\x74\162\171\x43\x6f\x64\145\x73"] = $blockedCountryCodes; goto C30f6; F1b23: $webAclRuleName = $awsWaf->getWebAclRuleName(AwsWaf::WEB_ACL_RULE_NAME_BLOCKED_COUNTRIES); goto d8827; f1681: $awsWaf = $this->getAwsWaf(); goto F1b23; Bce05: $blockedCountryCodes = $this->getBlockedCountryCodes(); goto f641a; E03fb: goto fe40e; goto bd241; E7c14: } protected function updateRateLimitValue() { goto e246d; d8cd3: $rateLimit = (int) $this->getRateLimit(); goto E4bbb; Cb319: E5de3: goto Ccc06; dbd2f: if (true === isset($this->webAcl["\122\x75\154\x65\x73"][$webAclRuleArrayIndex])) { goto ced0f; } goto Fc25b; A58c7: e0e13: goto F0abb; C186d: if (true === isset($this->webAcl["\122\x75\154\145\x73"][$webAclRuleArrayIndex])) { goto E0919; } goto De361; e246d: $awsWaf = $this->getAwsWaf(); goto d8cd3; E4bbb: $webAclRuleNameRateLimitIPv4 = $awsWaf->getWebAclRuleName(AwsWaf::WEB_ACL_RULE_NAME_RATE_LIMIT_IPV4); goto dc195; B0cd0: goto e0e13; goto Ab1ed; Db84c: $this->webAcl["\x52\165\x6c\145\163"][$webAclRuleArrayIndex]["\x53\164\x61\x74\145\x6d\x65\156\164"]["\x52\x61\x74\x65\102\141\163\145\144\x53\164\x61\x74\x65\155\145\x6e\164"]["\114\151\x6d\151\164"] = $rateLimit; goto A58c7; Fc25b: throw new \Exception(sprintf("\127\x65\142\40\101\x43\x4c\40\122\x75\154\145\x20\42\45\x73\x22\x20\156\157\x74\x20\x66\157\x75\156\x64\56", $webAclRuleNameRateLimitIPv4)); goto B0cd0; cd62e: $webAclRuleArrayIndex = $this->getWebAclRuleArrayIndex($webAclRuleNameRateLimitIPv6); goto C186d; F0abb: $webAclRuleNameRateLimitIPv6 = $awsWaf->getWebAclRuleName(AwsWaf::WEB_ACL_RULE_NAME_RATE_LIMIT_IPV6); goto cd62e; dc195: $webAclRuleArrayIndex = $this->getWebAclRuleArrayIndex($webAclRuleNameRateLimitIPv4); goto dbd2f; De361: throw new \Exception(sprintf("\127\145\x62\40\x41\x43\x4c\40\122\165\154\145\40\42\x25\163\x22\x20\x6e\x6f\164\40\146\x6f\x75\156\144\x2e", $webAclRuleNameRateLimitIPv6)); goto Cf6c9; Ab1ed: ced0f: goto Db84c; Cf6c9: goto E5de3; goto Dbeb1; Dbeb1: E0919: goto ea243; ea243: $this->webAcl["\122\x75\x6c\145\163"][$webAclRuleArrayIndex]["\x53\x74\x61\x74\145\155\145\x6e\x74"]["\122\141\x74\x65\x42\141\x73\145\144\123\164\141\164\x65\x6d\145\x6e\x74"]["\114\x69\155\x69\164"] = $rateLimit; goto Cb319; Ccc06: } protected function updateRateLimitWhitelistedIpSets() { goto Aaeb4; a0720: A76d0: goto B0c42; Bf04d: Ba590: goto d55cc; d55cc: foreach ($this->rateLimitWhitelistedIpsIpv6 as &$ip) { $ip = sprintf("\x25\x73\57\61\62\70", $ip); C1490: } goto a0720; B0c42: $awsWaf = $this->getAwsWaf(); goto Be1b1; fe642: $awsWaf->updateIpSet(AwsWaf::IP_SET_RATE_LIMIT_WHITELISTED_IPV6, $this->rateLimitWhitelistedIpsIpv6); goto fdffa; Aaeb4: foreach ($this->rateLimitWhitelistedIpsIpv4 as &$ip) { $ip = sprintf("\45\x73\x2f\x33\62", $ip); Bca24: } goto Bf04d; Be1b1: $awsWaf->updateIpSet(AwsWaf::IP_SET_RATE_LIMIT_WHITELISTED_IPV4, $this->rateLimitWhitelistedIpsIpv4); goto fe642; fdffa: } protected function updateBlockedIpsIpSets() { goto C240f; cd8d6: foreach ($this->blockedIpsIpv6 as &$ip) { $ip = sprintf("\x25\x73\x2f\61\x32\x38", $ip); E3cb3: } goto f4aaa; ffd78: $awsWaf->updateIpSet(AwsWaf::IP_SET_BLOCKED_IPS_IPV4, $this->blockedIpsIpv4); goto d6ef7; C240f: foreach ($this->blockedIpsIpv4 as &$ip) { $ip = sprintf("\45\163\57\63\x32", $ip); D1607: } goto F9a19; f4aaa: adab1: goto ecdfb; d6ef7: $awsWaf->updateIpSet(AwsWaf::IP_SET_BLOCKED_IPS_IPV6, $this->blockedIpsIpv6); goto Ec15d; F9a19: E1d7e: goto cd8d6; ecdfb: $awsWaf = $this->getAwsWaf(); goto ffd78; Ec15d: } protected function updateBlockedBots() { goto edb6d; c2b76: $awsWaf = $this->getAwsWaf(); goto c15f9; bcdb8: C460f: goto c2b76; Cb6dc: if (!(true === empty($blockedBots))) { goto C460f; } goto f36ea; f36ea: $blockedBots[] = "\155\x67\x74"; goto bcdb8; c15f9: $awsWaf->updateBlockedBotsRegexPatternSet($blockedBots); goto cbe7f; edb6d: $blockedBots = $this->getBlockedBots(); goto Cb6dc; cbe7f: } protected function getAwsWaf() { goto ec2ee; f9a7d: $awsAccessKey = $this->getAwsAccessKey(); goto e4b91; e4b91: $awsSecretAccessKey = $this->getAwsSecretAccessKey(); goto b8d9c; c5a1f: $projectName = $this->getProjectName(); goto D630a; ec2ee: if (!(true === is_null($this->awsWaf))) { goto e829d; } goto f9a7d; B5e3f: return $this->awsWaf; goto B2810; b8d9c: $awsRegion = $this->getAwsRegion(); goto c5a1f; cca0b: e829d: goto B5e3f; D630a: $this->awsWaf = new AwsWaf($awsAccessKey, $awsSecretAccessKey, $awsRegion, $projectName); goto cca0b; B2810: } protected function getAwsAccessKey() { goto ff808; ae17c: return $this->awsAccessKey; goto A633a; F6ef5: Af5bc: goto ae17c; ff808: if (!(true === is_null($this->awsAccessKey))) { goto Af5bc; } goto ba73f; ba73f: $this->awsAccessKey = $this->getConfigValue("\163\x65\x74\x74\x69\x6e\147\163", "\141\x77\163\x5f\141\143\x63\145\x73\x73\x5f\153\x65\171"); goto F6ef5; A633a: } protected function getAwsSecretAccessKey() { goto Ab022; d3071: $this->awsSecretAccessKey = $this->getConfigValue("\x73\x65\164\x74\x69\x6e\147\163", "\141\167\163\137\163\145\143\x72\145\x74\x5f\141\x63\143\x65\163\x73\x5f\153\x65\x79"); goto Ddf0f; Ab022: if (!(true === is_null($this->awsSecretAccessKey))) { goto f6ab6; } goto d3071; B64bc: return $this->awsSecretAccessKey; goto D43d1; Ddf0f: f6ab6: goto B64bc; D43d1: } protected function getAwsRegion() { goto B73bb; F7f3e: $this->awsRegion = $this->getConfigValue("\x73\145\x74\x74\x69\x6e\147\x73", "\x61\167\x73\137\x72\x65\x67\x69\157\156"); goto cac8e; B73bb: if (!(true == is_null($this->awsRegion))) { goto e1f77; } goto F7f3e; cac8e: e1f77: goto Fe95b; Fe95b: return $this->awsRegion; goto d5817; d5817: } protected function getProjectName() { goto C9ffd; C9ffd: if (!(true === is_null($this->projectName))) { goto ab1ad; } goto B236c; ce9c6: ab1ad: goto F54b5; B236c: $this->projectName = $this->getConfigValue("\x73\x65\x74\164\x69\x6e\x67\x73", "\x70\162\157\152\x65\x63\164\137\156\141\x6d\x65"); goto ce9c6; F54b5: return $this->projectName; goto ee16b; ee16b: } protected function getRateLimit() { goto E5d56; E5d56: if (!(true === is_null($this->rateLimit))) { goto Adde3; } goto Cba24; A3906: Adde3: goto E4789; Cba24: $this->rateLimit = $this->getConfigValue("\x72\141\164\x65\137\154\x69\x6d\x69\x74", "\162\141\x74\145\x5f\x6c\151\155\151\x74"); goto A3906; E4789: return $this->rateLimit; goto d19f0; d19f0: } protected function getBlockedCountryCodes() { goto F4b3f; B61ae: D64c2: goto ff0aa; ff0aa: b2dc9: goto fd593; baa06: if (!(false === empty($blockedCountryCodes))) { goto D64c2; } goto Dc13f; F4b3f: if (!(true === empty($this->blockedCountryCodes))) { goto b2dc9; } goto Ba6e0; Ba6e0: $blockedCountryCodes = $this->getConfigValue("\142\154\157\143\x6b\x65\144\x5f\x63\157\x75\156\164\162\151\145\x73", "\x63\157\x75\156\164\162\x79\x5f\143\157\144\x65\163"); goto baa06; fd593: return $this->blockedCountryCodes; goto Acf0f; Dc13f: $this->blockedCountryCodes = $blockedCountryCodes; goto B61ae; Acf0f: } protected function getBlockedIps() { goto C46c8; daa5a: if (!(false === empty($blockedIps))) { goto F1785; } goto B4c01; Af831: return $this->blockedIps; goto Ee505; Dd767: $blockedIps = array_filter(array_map("\x74\162\x69\x6d", $blockedIps)); goto daa5a; Bd562: $blockedIps = $this->getConfigValue("\x62\x6c\157\x63\x6b\x65\x64\137\x69\160\163", "\x62\154\157\143\153\x65\144\x5f\151\x70\163"); goto Df691; C46c8: if (!(true === empty($this->blockedIps))) { goto f7c26; } goto Bd562; ddebd: F1785: goto efc05; efc05: f7c26: goto Af831; B4c01: $this->blockedIps = $blockedIps; goto ddebd; Df691: $blockedIps = explode(PHP_EOL, $blockedIps); goto Dd767; Ee505: } protected function getRateLimitWhitelistedIps() { goto Ae522; Ae522: if (!(true === empty($this->rateLimitWhitelistedIps))) { goto a2c48; } goto Df536; Df536: $rateLimitWhitelistedIps = $this->getConfigValue("\162\x61\x74\x65\x5f\154\151\155\x69\x74", "\x77\150\x69\x74\x65\154\x69\x73\x74\145\144\137\151\x70\x73"); goto a6ca8; Fcf72: $rateLimitWhitelistedIps = array_filter(array_map("\164\x72\x69\x6d", $rateLimitWhitelistedIps)); goto c0767; a6ca8: $rateLimitWhitelistedIps = explode(PHP_EOL, $rateLimitWhitelistedIps); goto Fcf72; df0da: b702a: goto C9147; C9147: a2c48: goto E5526; A7de2: $this->rateLimitWhitelistedIps = $rateLimitWhitelistedIps; goto df0da; c0767: if (!(false === empty($rateLimitWhitelistedIps))) { goto b702a; } goto A7de2; E5526: return $this->rateLimitWhitelistedIps; goto C16d2; C16d2: } protected function getBlockedBots() { goto B5579; C18ac: Be076: goto be2bb; a99ef: if (!(false === empty($blockedBots))) { goto e2ded; } goto Cbb62; Dc8a4: $blockedBots = explode(PHP_EOL, $blockedBots); goto Da4ac; Bc01b: $blockedBots = $this->getConfigValue("\x62\154\x6f\143\153\x65\144\137\x62\157\164\x73", "\142\x6c\157\143\153\x65\x64\137\x62\x6f\164\x73"); goto Dc8a4; be2bb: return $this->blockedBots; goto F7f7b; Da4ac: $blockedBots = array_filter(array_map("\x74\x72\x69\155", $blockedBots)); goto a99ef; Cbb62: $this->blockedBots = $blockedBots; goto F6875; F6875: e2ded: goto C18ac; B5579: if (!(true === empty($this->blockedBots))) { goto Be076; } goto Bc01b; F7f7b: } protected function getMagentoBackendWhitelistedIps() { goto B4884; d20fa: if (!(false === empty($magentoBackendWhitelistedIps))) { goto e73a3; } goto Ef7eb; e75ce: return $this->magentoBackendWhitelistedIps; goto A8d25; E9f8c: f71d2: goto e75ce; Bdaa4: e73a3: goto E9f8c; B4884: if (!(true === empty($this->magentoBackendWhitelistedIps))) { goto f71d2; } goto c5acd; c9115: $magentoBackendWhitelistedIps = array_filter(array_map("\x74\x72\151\x6d", $magentoBackendWhitelistedIps)); goto d20fa; c5acd: $magentoBackendWhitelistedIps = $this->getConfigValue("\155\x61\147\x65\x6e\164\x6f\137\x62\141\143\x6b\145\156\144", "\x77\x68\x69\164\145\x6c\x69\x73\164\x65\144\x5f\x69\x70\x73"); goto F01af; Ef7eb: $this->magentoBackendWhitelistedIps = $magentoBackendWhitelistedIps; goto Bdaa4; F01af: $magentoBackendWhitelistedIps = explode(PHP_EOL, $magentoBackendWhitelistedIps); goto c9115; A8d25: } protected function isMagentoBackendRestricted() { goto C61ba; F4b75: return $this->isMagentoBackendRestricted; goto bb360; f8353: $this->isMagentoBackendRestricted = $configValue == self::MAGENTO_BACKEND_RESTRICTION_ENABLED ? true : false; goto F4b75; C61ba: $configValue = $this->getConfigValue("\x6d\141\x67\x65\156\164\x6f\137\142\x61\x63\x6b\x65\x6e\144", "\x69\x73\137\145\156\141\x62\x6c\145\x64"); goto f8353; bb360: } protected function getWebAcl() { goto d7407; B3440: $this->webAcl = $awsWaf->getWebAcl($webAclName); goto D2441; D2441: bde20: goto ece0f; ece0f: return $this->webAcl; goto a170c; b9cb5: $awsWaf = $this->getAwsWaf(); goto fdbcf; fdbcf: $webAclName = $this->getWebAclName(); goto B3440; d7407: if (!(true === is_null($this->webAcl))) { goto bde20; } goto b9cb5; a170c: } protected function getWebAclName() { goto E7a82; F1bd5: b948b: goto abcee; A90c0: $this->webAclName = sprintf("\45\163\x2d\115\x47\x54\x2d\x57\145\x62\x2d\x41\103\114", $projectName); goto F1bd5; E7a82: if (!(true === is_null($this->webAclName))) { goto b948b; } goto E6db4; abcee: return $this->webAclName; goto c8406; E6db4: $projectName = ucfirst($this->getProjectName()); goto A90c0; c8406: } protected function getWebAclRuleArrayIndex($webAclRuleName) { goto D0fc6; B4f05: if (false === is_null($arrayIndex) && true === isset($webAclRules[$arrayIndex])) { goto b779a; } goto B9e9f; Ca519: b779a: goto Ef02e; Ead63: $arrayIndex = array_search($webAclRuleName, array_column($webAclRules, "\116\141\155\145")); goto B4f05; A5bda: goto b2ac6; goto Ca519; Fb004: $webAclRules = $webAcl["\122\165\154\x65\x73"] ?? []; goto Ead63; B9e9f: throw new \Exception(sprintf("\127\145\x62\x20\x41\x43\x4c\40\122\165\x6c\x65\x20\42\45\163\42\x20\x6e\x6f\x74\40\x66\157\x75\156\144\x2e", $webAclRuleName)); goto A5bda; Ef02e: return $arrayIndex; goto Fa518; Fa518: b2ac6: goto c58ce; D0fc6: $webAcl = $this->getWebAcl(); goto Fb004; c58ce: } protected function getBackendFrontName() { $backendFrontName = $this->deploymentConfig->get(BackendConfigOptionsList::CONFIG_PATH_BACKEND_FRONTNAME); return $backendFrontName; } protected function getConfigValue($group, $field) { goto E27fd; Df7da: if (!(true === is_string($configValue))) { goto D2b13; } goto de023; C0b91: return $configValue; goto e1069; ff88a: D2b13: goto D9e81; E27fd: $configValue = ''; goto Da999; Da999: if (!(true === isset($this->configData["\x67\x72\157\x75\160\163"][$group]["\x66\151\145\x6c\144\x73"][$field]["\x76\141\154\x75\145"]))) { goto Df0c9; } goto D7561; de023: $configValue = trim($configValue); goto ff88a; D7561: $configValue = $this->configData["\x67\x72\157\x75\160\x73"][$group]["\146\151\x65\154\x64\163"][$field]["\x76\141\x6c\x75\145"]; goto Df7da; D9e81: Df0c9: goto C0b91; e1069: } protected function retry(callable $fn, $retries = 2, $delay = 3) { return Retry::retry($fn, $retries, $delay); } }
